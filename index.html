<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SIGNAL â€” ëª¨ìŠ¤ë¶€í˜¸ í›ˆë ¨ì†Œ</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&family=Noto+Sans+KR:wght@300;400;700&display=swap');

  :root {
    --bg: #0a0e0a;
    --bg2: #0f1510;
    --panel: #111a11;
    --panel2: #162016;
    --green: #39ff5a;
    --green2: #1aff3a;
    --green-dim: #1a5c28;
    --green-glow: rgba(57,255,90,0.15);
    --amber: #ffb300;
    --amber-dim: #7a5600;
    --red: #ff3a3a;
    --text: #c8f0c8;
    --text-dim: #4a7a4a;
    --border: #1e3a1e;
    --border2: #2a4a2a;
    --scanline: rgba(0,0,0,0.08);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans KR', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
    cursor: crosshair;
  }

  /* CRT scanline overlay */
  body::before {
    content:'';
    position:fixed;
    inset:0;
    background: repeating-linear-gradient(
      0deg,
      var(--scanline) 0px,
      var(--scanline) 1px,
      transparent 1px,
      transparent 3px
    );
    pointer-events:none;
    z-index:9999;
  }

  /* Noise texture */
  body::after {
    content:'';
    position:fixed;
    inset:0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events:none;
    z-index:9998;
    opacity:0.4;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:16px 32px;
    border-bottom:1px solid var(--border2);
    background: linear-gradient(180deg, rgba(57,255,90,0.04) 0%, transparent 100%);
    position:relative;
  }

  .logo {
    font-family:'Orbitron', monospace;
    font-size:1.8rem;
    font-weight:900;
    letter-spacing:0.3em;
    color: var(--green);
    text-shadow: 0 0 20px var(--green), 0 0 60px rgba(57,255,90,0.3);
    animation: pulse-glow 3s ease-in-out infinite;
  }

  @keyframes pulse-glow {
    0%,100% { text-shadow: 0 0 20px var(--green), 0 0 60px rgba(57,255,90,0.3); }
    50% { text-shadow: 0 0 30px var(--green), 0 0 90px rgba(57,255,90,0.5), 0 0 120px rgba(57,255,90,0.2); }
  }

  .logo-sub {
    font-family:'Share Tech Mono', monospace;
    font-size:0.65rem;
    color: var(--text-dim);
    letter-spacing:0.2em;
    margin-top:2px;
  }

  .header-stats {
    display:flex;
    gap:24px;
    font-family:'Share Tech Mono', monospace;
    font-size:0.8rem;
    color: var(--text-dim);
  }

  .stat-item { display:flex; flex-direction:column; align-items:flex-end; }
  .stat-val { color:var(--green); font-size:1.1rem; font-weight:700; }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MAIN LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .main-container {
    display:grid;
    grid-template-columns:220px 1fr;
    min-height: calc(100vh - 73px);
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .sidebar {
    border-right:1px solid var(--border2);
    padding:20px 12px;
    display:flex;
    flex-direction:column;
    gap:8px;
    background: linear-gradient(180deg, var(--panel) 0%, var(--bg2) 100%);
  }

  .sidebar-label {
    font-family:'Share Tech Mono', monospace;
    font-size:0.6rem;
    color:var(--text-dim);
    letter-spacing:0.25em;
    padding:0 8px;
    margin-top:8px;
  }

  .nav-btn {
    background: transparent;
    border:1px solid var(--border);
    color: var(--text-dim);
    padding:12px 14px;
    border-radius:6px;
    cursor:pointer;
    font-family:'Noto Sans KR', sans-serif;
    font-size:0.85rem;
    text-align:left;
    transition: all 0.2s;
    position:relative;
    overflow:hidden;
  }

  .nav-btn::before {
    content:'';
    position:absolute;
    left:0; top:0; bottom:0;
    width:3px;
    background:var(--green);
    transform:scaleY(0);
    transition:transform 0.2s;
  }

  .nav-btn:hover, .nav-btn.active {
    border-color:var(--green-dim);
    color:var(--green);
    background: var(--green-glow);
  }

  .nav-btn.active::before { transform:scaleY(1); }

  .nav-icon { font-size:1.1rem; margin-right:8px; }

  .difficulty-section { margin-top:auto; }

  .diff-label {
    font-family:'Share Tech Mono', monospace;
    font-size:0.6rem;
    color:var(--text-dim);
    letter-spacing:0.25em;
    padding:0 8px;
    margin-bottom:8px;
  }

  .diff-btns { display:flex; gap:6px; padding:0 8px; }

  .diff-btn {
    flex:1;
    padding:8px 4px;
    border-radius:4px;
    border:1px solid var(--border);
    background:transparent;
    color:var(--text-dim);
    font-family:'Share Tech Mono', monospace;
    font-size:0.7rem;
    cursor:pointer;
    transition:all 0.2s;
    text-align:center;
  }

  .diff-btn:hover { border-color:var(--amber-dim); color:var(--amber); }
  .diff-btn.active-easy { border-color:#39ff5a; color:#39ff5a; background:rgba(57,255,90,0.1); }
  .diff-btn.active-mid  { border-color:var(--amber); color:var(--amber); background:rgba(255,179,0,0.1); }
  .diff-btn.active-hard { border-color:var(--red); color:var(--red); background:rgba(255,58,58,0.1); }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CONTENT AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .content {
    padding:28px 36px;
    overflow-y:auto;
  }

  .screen { display:none; animation:fadeIn 0.35s ease; }
  .screen.active { display:block; }

  @keyframes fadeIn {
    from { opacity:0; transform:translateY(8px); }
    to   { opacity:1; transform:translateY(0); }
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TITLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .screen-title {
    font-family:'Orbitron', monospace;
    font-size:1.1rem;
    letter-spacing:0.15em;
    color:var(--green);
    margin-bottom:6px;
  }

  .screen-desc {
    font-size:0.82rem;
    color:var(--text-dim);
    font-family:'Share Tech Mono', monospace;
    margin-bottom:24px;
    letter-spacing:0.05em;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ MORSE DISPLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .morse-display {
    background: var(--panel);
    border:1px solid var(--border2);
    border-radius:12px;
    padding:28px;
    margin-bottom:20px;
    position:relative;
    overflow:hidden;
  }

  .morse-display::before {
    content:'';
    position:absolute;
    inset:0;
    background: radial-gradient(ellipse at 50% 0%, rgba(57,255,90,0.06) 0%, transparent 60%);
  }

  .target-char {
    font-family:'Orbitron', monospace;
    font-size:5rem;
    font-weight:900;
    color:var(--green);
    text-align:center;
    text-shadow: 0 0 40px var(--green), 0 0 80px rgba(57,255,90,0.3);
    line-height:1;
    margin-bottom:8px;
  }

  .target-morse {
    font-family:'Share Tech Mono', monospace;
    font-size:1.6rem;
    color:var(--text-dim);
    text-align:center;
    letter-spacing:0.3em;
    min-height:2.2rem;
    transition: color 0.3s;
  }

  .target-morse.revealed { color:var(--amber); }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SIGNAL BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .signal-container {
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:center;
    margin:16px 0;
    flex-wrap:wrap;
  }

  .signal-dot {
    width:20px; height:20px;
    border-radius:50%;
    background:var(--green);
    box-shadow: 0 0 12px var(--green), 0 0 24px rgba(57,255,90,0.5);
    opacity:0;
    transition: opacity 0.05s;
  }

  .signal-dash {
    width:60px; height:20px;
    border-radius:10px;
    background:var(--green);
    box-shadow: 0 0 12px var(--green), 0 0 24px rgba(57,255,90,0.5);
    opacity:0;
    transition: opacity 0.05s;
  }

  .signal-dot.lit, .signal-dash.lit { opacity:1; }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ INPUT AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .input-area {
    display:flex;
    gap:12px;
    margin-bottom:20px;
    align-items:center;
  }

  .answer-input {
    flex:1;
    background: var(--panel);
    border:1px solid var(--border2);
    border-radius:8px;
    padding:14px 20px;
    font-family:'Orbitron', monospace;
    font-size:1.4rem;
    color:var(--green);
    outline:none;
    letter-spacing:0.2em;
    transition: border-color 0.2s;
    text-transform:uppercase;
  }

  .answer-input:focus { border-color:var(--green-dim); box-shadow:0 0 20px var(--green-glow); }
  .answer-input.correct { border-color:var(--green); animation:flash-green 0.4s; }
  .answer-input.wrong   { border-color:var(--red); animation:flash-red 0.4s; }

  @keyframes flash-green {
    0%,100% { box-shadow:0 0 0 rgba(57,255,90,0); }
    50% { box-shadow:0 0 30px rgba(57,255,90,0.6); }
  }

  @keyframes flash-red {
    0%,100% { box-shadow:0 0 0 rgba(255,58,58,0); }
    50% { box-shadow:0 0 30px rgba(255,58,58,0.6); }
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .btn {
    padding:12px 24px;
    border-radius:8px;
    border:1px solid var(--green-dim);
    background: transparent;
    color:var(--green);
    font-family:'Orbitron', monospace;
    font-size:0.75rem;
    letter-spacing:0.1em;
    cursor:pointer;
    transition:all 0.2s;
    white-space:nowrap;
  }

  .btn:hover {
    background:var(--green-glow);
    box-shadow:0 0 20px var(--green-glow);
    border-color:var(--green);
  }

  .btn-primary {
    background:var(--green);
    color:var(--bg);
    font-weight:700;
    box-shadow:0 0 20px rgba(57,255,90,0.3);
  }

  .btn-primary:hover {
    background:var(--green2);
    box-shadow:0 0 30px rgba(57,255,90,0.5);
    color:var(--bg);
  }

  .btn-amber { border-color:var(--amber-dim); color:var(--amber); }
  .btn-amber:hover { border-color:var(--amber); background:rgba(255,179,0,0.1); }

  .btn-row { display:flex; gap:10px; flex-wrap:wrap; }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ FEEDBACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .feedback {
    height:28px;
    font-family:'Share Tech Mono', monospace;
    font-size:0.9rem;
    letter-spacing:0.1em;
    text-align:center;
    transition:all 0.3s;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
  }

  .feedback.ok  { color:var(--green); }
  .feedback.err { color:var(--red); }
  .feedback.info{ color:var(--amber); }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PROGRESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .progress-bar-wrap {
    background:var(--panel);
    border-radius:4px;
    height:6px;
    overflow:hidden;
    margin-bottom:20px;
    border:1px solid var(--border);
  }

  .progress-bar-fill {
    height:100%;
    background: linear-gradient(90deg, var(--green-dim), var(--green));
    border-radius:4px;
    transition:width 0.4s ease;
    box-shadow:0 0 10px rgba(57,255,90,0.4);
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TRANSMIT MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .key-area {
    background:var(--panel);
    border:1px solid var(--border2);
    border-radius:12px;
    padding:28px;
    margin-bottom:20px;
    text-align:center;
    position:relative;
    user-select:none;
  }

  .key-btn {
    display:inline-block;
    background:var(--panel2);
    border:2px solid var(--border2);
    border-radius:12px;
    padding:20px 40px;
    font-family:'Orbitron', monospace;
    font-size:0.75rem;
    letter-spacing:0.15em;
    color:var(--text-dim);
    cursor:pointer;
    transition:all 0.05s;
    margin:8px;
    box-shadow: 0 6px 0 #060a06, 0 8px 15px rgba(0,0,0,0.4);
    -webkit-user-select:none;
    user-select:none;
  }

  .key-btn.active, .key-btn:active {
    transform:translateY(3px);
    box-shadow: 0 3px 0 #060a06, 0 4px 8px rgba(0,0,0,0.4);
    border-color:var(--green);
    color:var(--green);
    background: var(--green-glow);
    box-shadow: 0 3px 0 #060a06, 0 0 20px var(--green-glow);
  }

  .input-morse-display {
    font-family:'Share Tech Mono', monospace;
    font-size:2rem;
    color:var(--green);
    letter-spacing:0.4em;
    min-height:3rem;
    padding:12px;
    text-shadow:0 0 10px rgba(57,255,90,0.5);
  }

  .input-decoded {
    font-family:'Share Tech Mono', monospace;
    font-size:1rem;
    color:var(--text-dim);
    letter-spacing:0.2em;
    min-height:1.5rem;
  }

  .timer-bar-wrap {
    background:var(--panel);
    border-radius:4px;
    height:8px;
    overflow:hidden;
    margin:12px 0;
    border:1px solid var(--border);
  }

  .timer-bar-fill {
    height:100%;
    background: linear-gradient(90deg, var(--red), var(--amber));
    border-radius:4px;
    transition:width 0.1s linear;
    box-shadow:0 0 10px rgba(255,100,0,0.4);
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ REFERENCE TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .ref-grid {
    display:grid;
    grid-template-columns:repeat(auto-fill, minmax(120px, 1fr));
    gap:8px;
    margin-bottom:24px;
  }

  .ref-card {
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:8px;
    padding:10px;
    text-align:center;
    cursor:pointer;
    transition:all 0.2s;
  }

  .ref-card:hover {
    border-color:var(--green-dim);
    background:var(--green-glow);
    transform:translateY(-2px);
  }

  .ref-char {
    font-family:'Orbitron', monospace;
    font-size:1.4rem;
    color:var(--green);
    font-weight:700;
  }

  .ref-morse {
    font-family:'Share Tech Mono', monospace;
    font-size:0.75rem;
    color:var(--text-dim);
    letter-spacing:0.2em;
    margin-top:4px;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SCORE / STATS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .score-panel {
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:12px;
    margin-bottom:24px;
  }

  .score-card {
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:10px;
    padding:16px;
    text-align:center;
  }

  .score-num {
    font-family:'Orbitron', monospace;
    font-size:2rem;
    font-weight:700;
    color:var(--green);
    text-shadow:0 0 15px rgba(57,255,90,0.4);
  }

  .score-lbl {
    font-family:'Share Tech Mono', monospace;
    font-size:0.65rem;
    color:var(--text-dim);
    letter-spacing:0.15em;
    margin-top:4px;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CHALLENGE SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .challenge-word {
    font-family:'Orbitron', monospace;
    font-size:3rem;
    font-weight:900;
    color:var(--green);
    text-align:center;
    letter-spacing:0.3em;
    text-shadow:0 0 30px rgba(57,255,90,0.4);
    margin:16px 0;
  }

  .challenge-morse {
    font-family:'Share Tech Mono', monospace;
    font-size:1rem;
    color:var(--text-dim);
    text-align:center;
    letter-spacing:0.2em;
    line-height:2;
    margin-bottom:16px;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ WORD TRANSMIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .word-letters {
    display:flex;
    gap:8px;
    justify-content:center;
    flex-wrap:wrap;
    margin:12px 0;
  }

  .word-letter {
    width:44px; height:44px;
    border-radius:6px;
    border:1px solid var(--border2);
    display:flex; align-items:center; justify-content:center;
    font-family:'Orbitron', monospace;
    font-size:1.1rem;
    color:var(--text-dim);
    transition:all 0.2s;
    position:relative;
  }

  .word-letter.current { border-color:var(--green); color:var(--green); background:var(--green-glow); }
  .word-letter.done    { border-color:var(--green-dim); color:var(--green); background:rgba(57,255,90,0.06); }
  .word-letter.error   { border-color:var(--red); color:var(--red); }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ RESULT OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .result-overlay {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.8);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:100;
    display:none;
  }

  .result-overlay.show { display:flex; animation:fadeIn 0.3s; }

  .result-box {
    background:var(--panel);
    border:1px solid var(--green-dim);
    border-radius:16px;
    padding:40px 60px;
    text-align:center;
    box-shadow:0 0 60px rgba(57,255,90,0.15);
    max-width:480px;
  }

  .result-title {
    font-family:'Orbitron', monospace;
    font-size:1.8rem;
    color:var(--green);
    letter-spacing:0.2em;
    margin-bottom:8px;
    text-shadow:0 0 20px var(--green);
  }

  .result-score {
    font-family:'Orbitron', monospace;
    font-size:4rem;
    font-weight:900;
    color:var(--green);
    text-shadow:0 0 40px var(--green), 0 0 80px rgba(57,255,90,0.3);
    margin:16px 0;
  }

  .result-sub {
    font-family:'Share Tech Mono', monospace;
    font-size:0.85rem;
    color:var(--text-dim);
    letter-spacing:0.1em;
    margin-bottom:24px;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SEPARATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .sep {
    border:none;
    border-top:1px solid var(--border);
    margin:20px 0;
  }

  .section-header {
    font-family:'Share Tech Mono', monospace;
    font-size:0.7rem;
    color:var(--text-dim);
    letter-spacing:0.2em;
    margin-bottom:12px;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TOOLTIP / HINT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .hint-box {
    background:rgba(255,179,0,0.07);
    border:1px solid var(--amber-dim);
    border-radius:8px;
    padding:12px 16px;
    font-family:'Share Tech Mono', monospace;
    font-size:0.78rem;
    color:var(--amber);
    letter-spacing:0.05em;
    line-height:1.7;
    margin-bottom:16px;
  }

  /* Responsive */
  @media(max-width:768px) {
    .main-container { grid-template-columns:1fr; }
    .sidebar { flex-direction:row; flex-wrap:wrap; border-right:none; border-bottom:1px solid var(--border2); padding:12px; }
    .score-panel { grid-template-columns:repeat(2,1fr); }
    .target-char { font-size:3.5rem; }
  }

  /* Flash animation for correct/wrong */
  .flash-correct { animation:bgFlashGreen 0.5s ease; }
  .flash-wrong   { animation:bgFlashRed   0.5s ease; }

  @keyframes bgFlashGreen {
    0%,100%{ background:var(--panel); }
    40%{ background:rgba(57,255,90,0.12); }
  }
  @keyframes bgFlashRed {
    0%,100%{ background:var(--panel); }
    40%{ background:rgba(255,58,58,0.12); }
  }

  .hidden { display:none !important; }

  /* WAVEFORM decoration */
  .waveform {
    display:flex;
    align-items:center;
    justify-content:center;
    gap:3px;
    height:30px;
    margin:8px 0;
    opacity:0.3;
  }

  .wave-bar {
    width:3px;
    background:var(--green);
    border-radius:2px;
    animation:wavePulse 1.2s ease-in-out infinite;
  }

  @keyframes wavePulse {
    0%,100% { transform:scaleY(0.3); }
    50% { transform:scaleY(1); }
  }

  /* Streak display */
  .streak-badge {
    display:inline-flex;
    align-items:center;
    gap:6px;
    background:rgba(255,179,0,0.1);
    border:1px solid var(--amber-dim);
    border-radius:20px;
    padding:4px 12px;
    font-family:'Share Tech Mono', monospace;
    font-size:0.8rem;
    color:var(--amber);
  }

  .tooltip {
    position:relative;
    cursor:help;
  }
  .tooltip .tip {
    display:none;
    position:absolute;
    bottom:110%;
    left:50%;
    transform:translateX(-50%);
    background:var(--panel2);
    border:1px solid var(--border2);
    border-radius:6px;
    padding:6px 10px;
    font-size:0.72rem;
    font-family:'Share Tech Mono', monospace;
    color:var(--text);
    white-space:nowrap;
    z-index:10;
    letter-spacing:0.05em;
  }
  .tooltip:hover .tip { display:block; }

  /* Volume indicator */
  .vol-indicator {
    width:8px; height:8px; border-radius:50%;
    background:var(--green);
    box-shadow:0 0 8px var(--green);
    display:inline-block;
    animation:blink 2s ease-in-out infinite;
  }

  @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

  .welcome-grid {
    display:grid;
    grid-template-columns:repeat(2,1fr);
    gap:16px;
    margin-top:24px;
  }

  .welcome-card {
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:12px;
    padding:24px;
    cursor:pointer;
    transition:all 0.25s;
    text-align:center;
  }

  .welcome-card:hover {
    border-color:var(--green-dim);
    background:var(--green-glow);
    transform:translateY(-4px);
    box-shadow:0 10px 30px rgba(0,0,0,0.3);
  }

  .welcome-card-icon { font-size:2.5rem; margin-bottom:12px; }
  .welcome-card-title {
    font-family:'Orbitron', monospace;
    font-size:0.9rem;
    color:var(--green);
    letter-spacing:0.1em;
    margin-bottom:6px;
  }
  .welcome-card-desc {
    font-size:0.78rem;
    color:var(--text-dim);
    line-height:1.6;
  }

  select {
    background:var(--panel);
    border:1px solid var(--border2);
    color:var(--text);
    padding:6px 12px;
    border-radius:6px;
    font-family:'Share Tech Mono', monospace;
    font-size:0.8rem;
    cursor:pointer;
    outline:none;
  }

  /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     SCENARIO MODE STYLES
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€*/

  /* API key setup */
  .api-setup {
    max-width: 520px;
    margin: 40px auto;
    text-align: center;
  }
  .api-input-wrap {
    display:flex; gap:10px; margin:16px 0;
  }
  .api-input {
    flex:1;
    background:var(--panel);
    border:1px solid var(--border2);
    border-radius:8px;
    padding:12px 16px;
    font-family:'Share Tech Mono', monospace;
    font-size:0.85rem;
    color:var(--green);
    outline:none;
    letter-spacing:0.05em;
  }
  .api-input:focus { border-color:var(--green-dim); box-shadow:0 0 12px var(--green-glow); }

  /* Scenario select */
  .scenario-cards {
    display:grid; grid-template-columns:repeat(2,1fr); gap:14px; margin:20px 0;
  }
  .scenario-card {
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:10px;
    padding:18px;
    cursor:pointer;
    transition:all 0.2s;
    text-align:left;
  }
  .scenario-card:hover {
    border-color:var(--amber-dim);
    background:rgba(255,179,0,0.05);
    transform:translateY(-3px);
  }
  .scenario-card.selected { border-color:var(--amber); background:rgba(255,179,0,0.08); }
  .sc-icon { font-size:1.8rem; margin-bottom:8px; }
  .sc-title {
    font-family:'Orbitron',monospace; font-size:0.8rem; color:var(--amber);
    letter-spacing:0.1em; margin-bottom:6px;
  }
  .sc-desc { font-size:0.75rem; color:var(--text-dim); line-height:1.6; }
  .sc-obj {
    margin-top:8px; padding:6px 10px;
    background:rgba(255,179,0,0.07);
    border-radius:4px;
    font-family:'Share Tech Mono',monospace;
    font-size:0.68rem; color:var(--amber); letter-spacing:0.05em;
  }

  /* Comms interface */
  .comms-header {
    display:flex; justify-content:space-between; align-items:center;
    padding:12px 18px;
    background:var(--panel);
    border:1px solid var(--border2);
    border-radius:10px;
    margin-bottom:14px;
  }
  .comms-callsign {
    font-family:'Orbitron',monospace; font-size:0.9rem; color:var(--amber);
    letter-spacing:0.15em;
  }
  .comms-status {
    font-family:'Share Tech Mono',monospace; font-size:0.7rem;
    display:flex; align-items:center; gap:8px;
  }
  .status-dot {
    width:8px; height:8px; border-radius:50%;
    background:var(--green); box-shadow:0 0 8px var(--green);
  }
  .status-dot.amber { background:var(--amber); box-shadow:0 0 8px var(--amber); }
  .status-dot.red   { background:var(--red);   box-shadow:0 0 8px var(--red); }

  /* Objective bar */
  .objective-bar {
    background:rgba(255,179,0,0.06);
    border:1px solid var(--amber-dim);
    border-radius:8px;
    padding:10px 16px;
    margin-bottom:14px;
    font-family:'Share Tech Mono',monospace;
    font-size:0.75rem;
    color:var(--amber);
    letter-spacing:0.05em;
    line-height:1.7;
  }
  .obj-item { display:flex; align-items:center; gap:8px; }
  .obj-check { color:var(--green); }
  .obj-pending { color:var(--text-dim); }

  /* Message log */
  .msg-log {
    background:var(--panel);
    border:1px solid var(--border2);
    border-radius:10px;
    padding:14px;
    height:280px;
    overflow-y:auto;
    margin-bottom:14px;
    display:flex;
    flex-direction:column;
    gap:10px;
    scroll-behavior:smooth;
  }
  .msg-log::-webkit-scrollbar { width:4px; }
  .msg-log::-webkit-scrollbar-track { background:var(--bg); }
  .msg-log::-webkit-scrollbar-thumb { background:var(--green-dim); border-radius:2px; }

  .msg-entry {
    border-radius:8px;
    padding:10px 14px;
    font-family:'Share Tech Mono',monospace;
    font-size:0.78rem;
    line-height:1.7;
    animation:fadeIn 0.3s ease;
  }
  .msg-entry.incoming {
    background:rgba(57,255,90,0.06);
    border-left:3px solid var(--green-dim);
    color:var(--text);
  }
  .msg-entry.outgoing {
    background:rgba(255,179,0,0.06);
    border-left:3px solid var(--amber-dim);
    color:var(--amber);
    margin-left:20px;
  }
  .msg-entry.system {
    background:rgba(255,58,58,0.05);
    border-left:3px solid rgba(255,58,58,0.4);
    color:rgba(255,58,58,0.7);
    font-size:0.7rem;
  }
  .msg-meta {
    font-size:0.65rem; color:var(--text-dim);
    margin-bottom:3px; letter-spacing:0.1em;
  }
  .msg-morse {
    font-size:0.7rem; color:var(--text-dim);
    letter-spacing:0.15em; margin-top:3px;
    word-break:break-all;
  }

  /* Transmit panel */
  .tx-panel {
    background:var(--panel);
    border:1px solid var(--border2);
    border-radius:10px;
    padding:16px;
    margin-bottom:12px;
  }
  .tx-morse-live {
    font-family:'Share Tech Mono',monospace;
    font-size:1.5rem;
    color:var(--green);
    letter-spacing:0.3em;
    min-height:2.2rem;
    text-shadow:0 0 8px rgba(57,255,90,0.4);
    word-break:break-all;
    padding:4px 0;
  }
  .tx-decoded-live {
    font-family:'Orbitron',monospace;
    font-size:1rem;
    color:var(--amber);
    letter-spacing:0.15em;
    min-height:1.4rem;
    margin-top:4px;
  }
  .tx-word-boundary {
    display:inline-block;
    opacity:0.3;
    margin:0 4px;
  }

  /* Signal visualizer for incoming */
  .signal-wave {
    display:flex; align-items:center; gap:4px;
    height:36px; overflow:hidden;
    padding:4px 0;
    flex-wrap:nowrap;
  }
  .sw-dot {
    width:10px; height:10px; border-radius:50%;
    flex-shrink:0;
    background:var(--green);
    box-shadow:0 0 8px var(--green);
    opacity:0; transition:opacity 0.04s;
  }
  .sw-dash {
    width:30px; height:10px; border-radius:5px;
    flex-shrink:0;
    background:var(--green);
    box-shadow:0 0 8px var(--green);
    opacity:0; transition:opacity 0.04s;
  }
  .sw-dot.on, .sw-dash.on { opacity:1; }

  /* Progress */
  .mission-progress {
    display:flex; gap:8px; align-items:center;
    font-family:'Share Tech Mono',monospace;
    font-size:0.7rem; color:var(--text-dim);
    margin-bottom:10px;
  }
  .mp-bar-wrap {
    flex:1; height:6px; background:var(--panel);
    border-radius:3px; overflow:hidden;
    border:1px solid var(--border);
  }
  .mp-bar-fill {
    height:100%;
    background:linear-gradient(90deg, var(--amber-dim), var(--amber));
    border-radius:3px;
    transition:width 0.6s ease;
  }

  /* Mission complete overlay */
  .mission-overlay {
    position:fixed; inset:0;
    background:rgba(0,0,0,0.85);
    display:none; align-items:center; justify-content:center;
    z-index:200;
  }
  .mission-overlay.show { display:flex; animation:fadeIn 0.4s; }
  .mission-box {
    background:var(--panel);
    border:1px solid var(--amber);
    border-radius:16px;
    padding:40px 50px;
    text-align:center;
    box-shadow:0 0 60px rgba(255,179,0,0.2);
    max-width:500px;
  }
  .mission-title {
    font-family:'Orbitron',monospace; font-size:1.5rem;
    color:var(--amber); letter-spacing:0.2em; margin-bottom:8px;
    text-shadow:0 0 20px var(--amber);
  }
  .mission-grade {
    font-family:'Orbitron',monospace; font-size:3.5rem;
    font-weight:900; margin:16px 0;
  }
  .grade-S { color:#ffd700; text-shadow:0 0 30px #ffd700; }
  .grade-A { color:var(--green); text-shadow:0 0 30px var(--green); }
  .grade-B { color:var(--amber); text-shadow:0 0 30px var(--amber); }
  .grade-C { color:var(--text-dim); }

  /* Receive waiting animation */
  @keyframes rcvPulse {
    0%,100%{ opacity:0.4; transform:scale(1); }
    50%{ opacity:1; transform:scale(1.05); }
  }
  .rcv-waiting {
    animation:rcvPulse 1.2s ease-in-out infinite;
    color:var(--green);
    font-family:'Share Tech Mono',monospace;
    font-size:0.8rem;
    letter-spacing:0.2em;
  }

  .key-hint {
    font-family:'Share Tech Mono',monospace;
    font-size:0.7rem; color:var(--text-dim);
    letter-spacing:0.1em;
    text-align:center; margin-top:8px;
  }

  .word-buffer {
    display:flex; gap:6px; flex-wrap:wrap;
    min-height:32px; margin:8px 0;
  }
  .wb-char {
    padding:4px 8px; border-radius:4px;
    font-family:'Orbitron',monospace; font-size:0.85rem;
    background:rgba(255,179,0,0.1); border:1px solid var(--amber-dim);
    color:var(--amber);
  }
  .wb-pending {
    padding:4px 8px; border-radius:4px;
    font-family:'Share Tech Mono',monospace; font-size:0.85rem;
    background:var(--panel2); border:1px solid var(--border);
    color:var(--green); letter-spacing:0.2em;
  }

  .thinking-dots::after {
    content:'';
    animation:dots 1.4s steps(4,end) infinite;
  }
  @keyframes dots {
    0%{content:''} 25%{content:'.'} 50%{content:'..'} 75%{content:'...'} 100%{content:''}
  }

  /* â”€â”€ Intel briefing panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .intel-panel {
    background: rgba(255,58,58,0.04);
    border: 1px solid rgba(255,58,58,0.25);
    border-radius: 10px;
    padding: 12px 14px;
    margin-bottom: 12px;
  }
  .intel-panel-title {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.62rem;
    color: rgba(255,58,58,0.7);
    letter-spacing: 0.25em;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .intel-row {
    display: flex;
    align-items: baseline;
    gap: 8px;
    padding: 5px 0;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }
  .intel-row:last-child { border-bottom: none; }
  .intel-label {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.65rem;
    color: rgba(255,58,58,0.6);
    letter-spacing: 0.1em;
    min-width: 90px;
    flex-shrink: 0;
  }
  .intel-value {
    font-family: 'Noto Sans KR', sans-serif;
    font-size: 0.88rem;
    color: #ff9090;
    font-weight: 700;
    flex: 1;
  }
  .intel-en {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.68rem;
    color: rgba(255,144,144,0.5);
    letter-spacing: 0.05em;
    margin-left: 4px;
  }
  .intel-hint {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.6rem;
    color: rgba(255,179,0,0.4);
    letter-spacing: 0.05em;
    margin-left: auto;
    text-align: right;
    flex-shrink: 0;
  }
  .intel-panel-toggle {
    cursor: pointer;
    user-select: none;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  .intel-panel-toggle:hover { color: rgba(255,100,100,0.9); }

</style>
</head>
<body>

<!-- Header -->
<header>
  <div>
    <div class="logo">SIGNAL</div>
    <div class="logo-sub">â–¸ ëª¨ìŠ¤ë¶€í˜¸ í›ˆë ¨ì†Œ / MORSE CODE TRAINER</div>
  </div>
  <div class="header-stats">
    <div class="stat-item">
      <span class="stat-val" id="headerScore">0</span>
      <span>ì´ ì ìˆ˜</span>
    </div>
    <div class="stat-item">
      <span class="stat-val" id="headerStreak">0</span>
      <span>ì—°ì† ì •ë‹µ</span>
    </div>
    <div class="stat-item">
      <span><span class="vol-indicator"></span> LIVE</span>
      <span style="font-size:0.65rem;">ì˜¤ë””ì˜¤ í™œì„±</span>
    </div>
  </div>
</header>

<!-- Main -->
<div class="main-container">

  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="sidebar-label">â–¸ ë©”ë‰´</div>
    <button class="nav-btn active" onclick="showScreen('home')" id="nav-home">
      <span class="nav-icon">ğŸ </span>í™ˆ
    </button>
    <button class="nav-btn" onclick="showScreen('study')" id="nav-study">
      <span class="nav-icon">ğŸ“š</span>í•™ìŠµí•˜ê¸°
    </button>
    <button class="nav-btn" onclick="showScreen('receive')" id="nav-receive">
      <span class="nav-icon">ğŸ“¡</span>ìˆ˜ì‹  í›ˆë ¨
    </button>
    <button class="nav-btn" onclick="showScreen('transmit')" id="nav-transmit">
      <span class="nav-icon">ğŸ“»</span>ë°œì‹  í›ˆë ¨
    </button>
    <button class="nav-btn" onclick="showScreen('word')" id="nav-word">
      <span class="nav-icon">ğŸ“</span>ë‹¨ì–´ ë„ì „
    </button>
    <button class="nav-btn" onclick="showScreen('challenge')" id="nav-challenge">
      <span class="nav-icon">âš¡</span>ìŠ¤í”¼ë“œ ì±Œë¦°ì§€
    </button>
    <button class="nav-btn" onclick="showScreen('scenario')" id="nav-scenario" style="border-color:var(--amber-dim);color:var(--amber);">
      <span class="nav-icon">ğŸ–ï¸</span>ì‘ì „ ì‹œë‚˜ë¦¬ì˜¤
    </button>

    <div class="difficulty-section">
      <div class="diff-label">â–¸ ë‚œì´ë„</div>
      <div class="diff-btns">
        <button class="diff-btn active-easy" onclick="setDifficulty('easy',this)">ì‰¬ì›€</button>
        <button class="diff-btn" onclick="setDifficulty('mid',this)">ë³´í†µ</button>
        <button class="diff-btn" onclick="setDifficulty('hard',this)">ì–´ë ¤ì›€</button>
      </div>
    </div>
  </nav>

  <!-- Content -->
  <div class="content">

    <!-- HOME -->
    <div class="screen active" id="screen-home">
      <div class="screen-title">â–¸ SIGNAL â€” ëª¨ìŠ¤ë¶€í˜¸ í›ˆë ¨ì†Œ</div>
      <div class="screen-desc">ì˜ì–´ ì•ŒíŒŒë²³ & ìˆ«ì ëª¨ìŠ¤ë¶€í˜¸ë¥¼ ìˆ˜ì‹ /ë°œì‹  ëª¨ë‘ ì™„ë²½í•˜ê²Œ ë§ˆìŠ¤í„°í•˜ì„¸ìš”</div>

      <div class="waveform">
        <div class="wave-bar" style="height:8px;animation-delay:0s"></div>
        <div class="wave-bar" style="height:16px;animation-delay:0.1s"></div>
        <div class="wave-bar" style="height:24px;animation-delay:0.2s"></div>
        <div class="wave-bar" style="height:14px;animation-delay:0.3s"></div>
        <div class="wave-bar" style="height:20px;animation-delay:0.4s"></div>
        <div class="wave-bar" style="height:10px;animation-delay:0.5s"></div>
        <div class="wave-bar" style="height:18px;animation-delay:0.6s"></div>
        <div class="wave-bar" style="height:26px;animation-delay:0.7s"></div>
        <div class="wave-bar" style="height:12px;animation-delay:0.8s"></div>
        <div class="wave-bar" style="height:22px;animation-delay:0.9s"></div>
      </div>

      <div class="welcome-grid">
        <div class="welcome-card" onclick="showScreen('study')">
          <div class="welcome-card-icon">ğŸ“š</div>
          <div class="welcome-card-title">í•™ìŠµí•˜ê¸°</div>
          <div class="welcome-card-desc">A~Z, 0~9 ëª¨ìŠ¤ë¶€í˜¸ í‘œë¥¼ ë³´ê³ <br>í´ë¦­í•´ì„œ ì†Œë¦¬ë¡œ í™•ì¸í•˜ì„¸ìš”</div>
        </div>
        <div class="welcome-card" onclick="showScreen('receive')">
          <div class="welcome-card-icon">ğŸ“¡</div>
          <div class="welcome-card-title">ìˆ˜ì‹  í›ˆë ¨</div>
          <div class="welcome-card-desc">ì‹ í˜¸ë¥¼ ë“£ê³  ì–´ë–¤ ê¸€ìì¸ì§€<br>ë§ì¶”ëŠ” í›ˆë ¨ì…ë‹ˆë‹¤</div>
        </div>
        <div class="welcome-card" onclick="showScreen('transmit')">
          <div class="welcome-card-icon">ğŸ“»</div>
          <div class="welcome-card-title">ë°œì‹  í›ˆë ¨</div>
          <div class="welcome-card-desc">ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ ì§ì ‘ ëª¨ìŠ¤ë¶€í˜¸ë¥¼<br>ì…ë ¥í•˜ëŠ” í›ˆë ¨ì…ë‹ˆë‹¤</div>
        </div>
        <div class="welcome-card" onclick="showScreen('challenge')">
          <div class="welcome-card-icon">âš¡</div>
          <div class="welcome-card-title">ìŠ¤í”¼ë“œ ì±Œë¦°ì§€</div>
          <div class="welcome-card-desc">ì œí•œ ì‹œê°„ ë‚´ì— ìµœëŒ€í•œ ë§ì€<br>ë¬¸ì œë¥¼ ë§ì¶°ë³´ì„¸ìš”!</div>
        </div>
      </div>

      <hr class="sep">
      <div class="hint-box">
        ğŸ’¡ <strong>ëª¨ìŠ¤ë¶€í˜¸ë€?</strong> â€” ì (Â·)ê³¼ ì„ (â€”)ì˜ ì¡°í•©ìœ¼ë¡œ ë¬¸ìë¥¼ í‘œí˜„í•˜ëŠ” í†µì‹  ë°©ì‹ì…ë‹ˆë‹¤.<br>
        ë‹¨ì (Â·) = ì§§ì€ ì‹ í˜¸ &nbsp;|&nbsp; ì¥ì„ (â€”) = ê¸´ ì‹ í˜¸ (3ë°° ê¸¸ì´) &nbsp;|&nbsp; ê¸€ì ì‚¬ì´ = 3ë°° ê°„ê²©<br>
        <strong>Tip:</strong> ì°¸ì¡° í˜ì´ì§€ì—ì„œ ê° ê¸€ìë¥¼ í´ë¦­í•˜ë©´ ì†Œë¦¬ë¥¼ ë“¤ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </div>
    </div>

    <!-- STUDY -->
    <div class="screen" id="screen-study">
      <div class="screen-title">â–¸ í•™ìŠµí•˜ê¸°</div>
      <div class="screen-desc">ê¸€ìë¥¼ í´ë¦­í•˜ë©´ ëª¨ìŠ¤ë¶€í˜¸ ì†Œë¦¬ë¥¼ ì¬ìƒí•©ë‹ˆë‹¤ â€” ê·€ë¡œ ìµíˆì„¸ìš”</div>

      <div class="section-header">â”€â”€ ALPHABET Aâ€“Z</div>
      <div class="ref-grid" id="refAlpha"></div>

      <hr class="sep">
      <div class="section-header">â”€â”€ NUMBERS 0â€“9</div>
      <div class="ref-grid" id="refNums"></div>

      <hr class="sep">
      <div class="hint-box">
        ğŸ’¡ <strong>ê¸°ì–µ íŒ:</strong> E = Â· (ê°€ì¥ ì§§ìŒ), T = â€” (ì„  í•˜ë‚˜), SOS = Â·Â·Â·â€”â€”â€”Â·Â·Â· &nbsp;|&nbsp; ìˆ«ìëŠ” í•­ìƒ 5ê°œ ê¸°í˜¸ì˜ ì¡°í•©ì…ë‹ˆë‹¤.
      </div>
    </div>

    <!-- RECEIVE -->
    <div class="screen" id="screen-receive">
      <div class="screen-title">â–¸ ìˆ˜ì‹  í›ˆë ¨</div>
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:20px;flex-wrap:wrap;">
        <div class="screen-desc" style="margin-bottom:0;">ì‹ í˜¸ë¥¼ ë“£ê³  ë¬¸ì ë˜ëŠ” ë‹¨ì–´ë¥¼ ë§ì¶”ì„¸ìš”</div>
        <div style="display:flex;gap:6px;margin-left:auto;">
          <button class="btn" id="rxModeChar" onclick="rxSetMode('char')"
            style="padding:6px 14px;font-size:0.72rem;border-color:var(--green);color:var(--green);background:var(--green-glow);">
            ê¸€ì ëª¨ë“œ
          </button>
          <button class="btn" id="rxModeWord" onclick="rxSetMode('word')"
            style="padding:6px 14px;font-size:0.72rem;">
            ë‹¨ì–´ ëª¨ë“œ
          </button>
        </div>
      </div>

      <div class="score-panel">
        <div class="score-card">
          <div class="score-num" id="rxScore">0</div>
          <div class="score-lbl">ì ìˆ˜</div>
        </div>
        <div class="score-card">
          <div class="score-num" id="rxStreak">0</div>
          <div class="score-lbl">ì—°ì† ì •ë‹µ</div>
        </div>
        <div class="score-card">
          <div class="score-num" id="rxCorrect">0</div>
          <div class="score-lbl">ì •ë‹µ</div>
        </div>
        <div class="score-card">
          <div class="score-num" id="rxWrong">0</div>
          <div class="score-lbl">ì˜¤ë‹µ</div>
        </div>
      </div>

      <div class="morse-display" id="rxDisplay">
        <div style="text-align:center; font-family:'Share Tech Mono'; color:var(--text-dim); font-size:0.8rem; letter-spacing:0.2em;">
          ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²« ë²ˆì§¸ ì‹ í˜¸ë¥¼ ìˆ˜ì‹ í•˜ì„¸ìš”
        </div>
        <div class="signal-container" id="rxSignals"></div>
      </div>

      <!-- ë‹¨ì–´ ëª¨ë“œ: ê¸€ì ì§„í–‰ í‘œì‹œ -->
      <div id="rxWordLetters" class="word-letters" style="display:none;justify-content:center;margin-bottom:12px;"></div>

      <div class="input-area">
        <input type="text" class="answer-input" id="rxInput" placeholder="?" maxlength="1" autocomplete="off" disabled>
        <button class="btn btn-amber" id="rxHintBtn" onclick="rxShowHint()" disabled>íŒíŠ¸</button>
        <button class="btn btn-primary" id="rxPlayBtn" onclick="rxPlay()">â–¶ ì‹ í˜¸ ì¬ìƒ</button>
      </div>

      <div class="feedback" id="rxFeedback"></div>

      <div class="btn-row" style="margin-top:12px;">
        <button class="btn btn-primary" id="rxStartBtn" onclick="rxStart()">â–¶ ì‹œì‘í•˜ê¸°</button>
        <button class="btn" onclick="rxPlay()" id="rxReplayBtn" disabled>â†º ë‹¤ì‹œ ë“£ê¸°</button>
        <button class="btn btn-amber" onclick="rxShowHint()" id="rxHintBtn2" disabled>ëª¨ìŠ¤ë¶€í˜¸ ë³´ê¸°</button>
      </div>

      <div class="hint-box hidden" id="rxHintBox"></div>
    </div>

    <!-- TRANSMIT -->
    <div class="screen" id="screen-transmit">
      <div class="screen-title">â–¸ ë°œì‹  í›ˆë ¨</div>
      <div class="screen-desc">í™”ë©´ì˜ ë¬¸ìë¥¼ ë³´ê³  ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ ëª¨ìŠ¤ë¶€í˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>

      <div class="hint-box">
        ğŸ›ï¸ <strong>ì¡°ì‘ë²•:</strong> <kbd style="background:var(--panel2);border:1px solid var(--border2);padding:2px 8px;border-radius:4px;font-family:monospace;">ìŠ¤í˜ì´ìŠ¤ë°”</kbd> ëˆ„ë¥´ê³  ìˆìœ¼ë©´ <strong>ì„ (â€”)</strong>, ì§§ê²Œ ëˆ„ë¥´ë©´ <strong>ì (Â·)</strong> &nbsp;|&nbsp;
        <kbd style="background:var(--panel2);border:1px solid var(--border2);padding:2px 8px;border-radius:4px;font-family:monospace;">Enter</kbd> ë¡œ ê¸€ì í™•ì •
      </div>

      <div class="score-panel">
        <div class="score-card">
          <div class="score-num" id="txScore">0</div>
          <div class="score-lbl">ì ìˆ˜</div>
        </div>
        <div class="score-card">
          <div class="score-num" id="txStreak">0</div>
          <div class="score-lbl">ì—°ì† ì •ë‹µ</div>
        </div>
        <div class="score-card">
          <div class="score-num" id="txCorrect">0</div>
          <div class="score-lbl">ì •ë‹µ</div>
        </div>
        <div class="score-card">
          <div class="score-num" id="txWrong">0</div>
          <div class="score-lbl">ì˜¤ë‹µ</div>
        </div>
      </div>

      <div class="morse-display" id="txDisplay">
        <div class="target-char" id="txTarget">?</div>
        <div style="font-family:'Share Tech Mono';font-size:0.75rem;color:var(--text-dim);text-align:center;letter-spacing:0.15em;">
          ëª©í‘œ ë¬¸ì
        </div>
      </div>

      <div class="key-area" id="txKeyArea">
        <div style="font-family:'Share Tech Mono';font-size:0.7rem;color:var(--text-dim);letter-spacing:0.2em;margin-bottom:12px;">
          â–¸ ì…ë ¥í•œ ëª¨ìŠ¤ë¶€í˜¸
        </div>
        <div class="input-morse-display" id="txMorseInput">â€”</div>
        <div class="input-decoded" id="txDecoded">ì…ë ¥ ëŒ€ê¸°ì¤‘</div>
        <div style="margin-top:16px;">
          <div class="key-btn" id="txKeyVisual"
            onmousedown="txKeyDown()" onmouseup="txKeyUp()"
            ontouchstart="txKeyDown()" ontouchend="txKeyUp()">
            â¬› SPACE â€” ëˆ„ë¥´ê¸°
          </div>
        </div>
      </div>

      <div class="feedback" id="txFeedback"></div>

      <div class="btn-row" style="margin-top:12px;">
        <button class="btn btn-primary" id="txStartBtn" onclick="txStart()">â–¶ ì‹œì‘í•˜ê¸°</button>
        <button class="btn" onclick="txClear()">âœ• ì§€ìš°ê¸°</button>
        <button class="btn btn-amber" onclick="txSubmit()" id="txSubmitBtn" disabled>âœ“ í™•ì • (Enter)</button>
        <button class="btn btn-amber" onclick="txShowAnswer()" id="txAnswerBtn" disabled>ì •ë‹µ ë³´ê¸°</button>
      </div>
    </div>

    <!-- WORD -->
    <div class="screen" id="screen-word">
      <div class="screen-title">â–¸ ë‹¨ì–´ ë°œì‹  ë„ì „</div>
      <div class="screen-desc">ë‹¨ì–´ë¥¼ í•œ ê¸€ìì”© ëª¨ìŠ¤ë¶€í˜¸ë¡œ ì…ë ¥í•´ë³´ì„¸ìš”</div>

      <div class="hint-box">
        ğŸ›ï¸ <strong>ì¡°ì‘ë²•:</strong> ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ ëª¨ìŠ¤ë¶€í˜¸ ì…ë ¥ â†’ Enterë¡œ ê¸€ì í™•ì •. ë‹¨ì–´ ì „ì²´ë¥¼ ì™„ì„±í•˜ì„¸ìš”!
      </div>

      <div class="morse-display">
        <div class="word-letters" id="wordLetters"></div>
        <div style="font-family:'Share Tech Mono';font-size:0.75rem;color:var(--text-dim);text-align:center;margin-top:8px;letter-spacing:0.15em;" id="wordCurrentMorse">â€”</div>
        <div class="input-morse-display" id="wordMorseInput" style="margin-top:8px;">â€”</div>
      </div>

      <div class="key-area">
        <div class="key-btn" id="wordKeyVisual"
          onmousedown="wordKeyDown()" onmouseup="wordKeyUp()"
          ontouchstart="wordKeyDown()" ontouchend="wordKeyUp()">
          â¬› SPACE â€” ëˆ„ë¥´ê¸°
        </div>
      </div>

      <div class="feedback" id="wordFeedback"></div>

      <div class="btn-row" style="margin-top:12px;">
        <button class="btn btn-primary" onclick="wordStart()">â–¶ ìƒˆ ë‹¨ì–´</button>
        <button class="btn" onclick="wordClear()">âœ• ì§€ìš°ê¸°</button>
        <button class="btn btn-amber" onclick="wordSubmitLetter()" id="wordSubmitBtn" disabled>âœ“ ê¸€ì í™•ì • (Enter)</button>
        <button class="btn btn-amber" onclick="wordShowAnswer()">ì •ë‹µ ë³´ê¸°</button>
      </div>

      <div style="margin-top:20px;">
        <div class="section-header">â”€â”€ ì™„ì„±ëœ ë‹¨ì–´ ê¸°ë¡</div>
        <div id="wordHistory" style="font-family:'Share Tech Mono';font-size:0.8rem;color:var(--text-dim);letter-spacing:0.1em;line-height:2.2;"></div>
      </div>
    </div>

    <!-- CHALLENGE -->
    <div class="screen" id="screen-challenge">
      <div class="screen-title">â–¸ ìŠ¤í”¼ë“œ ì±Œë¦°ì§€</div>
      <div class="screen-desc">60ì´ˆ ì•ˆì— ìµœëŒ€í•œ ë§ì´ ë§ì¶”ì„¸ìš”! ìˆ˜ì‹  + ë°œì‹  í†µí•© ëª¨ë“œ</div>

      <div id="chReady">
        <div style="text-align:center;padding:40px 0;">
          <div style="font-family:'Orbitron',monospace;font-size:2rem;color:var(--green);letter-spacing:0.2em;margin-bottom:16px;">
            âš¡ ì±Œë¦°ì§€ ì¤€ë¹„
          </div>
          <div style="font-family:'Share Tech Mono';color:var(--text-dim);font-size:0.85rem;letter-spacing:0.1em;margin-bottom:24px;line-height:1.8;">
            60ì´ˆ ì œí•œ &nbsp;|&nbsp; ìˆ˜ì‹  ë¬¸ì œ (ì‹ í˜¸ ë“£ê³  ë§ì¶”ê¸°) &nbsp;|&nbsp; ì—°ì† ì •ë‹µ ë³´ë„ˆìŠ¤<br>
            ì •ë‹µ: +10ì  &nbsp;|&nbsp; ì—°ì† 2ê°œ: +5 ë³´ë„ˆìŠ¤ &nbsp;|&nbsp; ì˜¤ë‹µ: -5ì 
          </div>
          <button class="btn btn-primary" onclick="chStart()" style="font-size:1rem;padding:16px 40px;">
            â–¶ ì±Œë¦°ì§€ ì‹œì‘
          </button>
        </div>
      </div>

      <div id="chGame" class="hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div class="score-card" style="flex:1;margin-right:12px;">
            <div class="score-num" id="chScore">0</div>
            <div class="score-lbl">ì ìˆ˜</div>
          </div>
          <div class="score-card" style="flex:1;margin-right:12px;">
            <div class="score-num" id="chCorrect">0</div>
            <div class="score-lbl">ì •ë‹µ</div>
          </div>
          <div class="score-card" style="flex:1;">
            <div class="score-num" id="chTimer" style="color:var(--amber);">60</div>
            <div class="score-lbl">ë‚¨ì€ ì‹œê°„</div>
          </div>
        </div>

        <div class="timer-bar-wrap">
          <div class="timer-bar-fill" id="chTimerBar" style="width:100%;"></div>
        </div>

        <div class="morse-display flash" id="chDisplay">
          <div class="signal-container" id="chSignals"></div>
          <div style="font-family:'Share Tech Mono';font-size:0.8rem;color:var(--text-dim);text-align:center;letter-spacing:0.2em;">ì‹ í˜¸ë¥¼ ë“£ê³  ë¬¸ìë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
        </div>

        <div class="input-area" style="margin-top:16px;">
          <input type="text" class="answer-input" id="chInput" placeholder="?" maxlength="1" autocomplete="off">
          <button class="btn" onclick="chPlaySignal()">â†º ë‹¤ì‹œ ë“£ê¸°</button>
        </div>

        <div class="feedback" id="chFeedback"></div>
      </div>
    </div>


    <!-- SCENARIO MODE -->
    <div class="screen" id="screen-scenario">
      <div class="screen-title">â–¸ ì‘ì „ ì‹œë‚˜ë¦¬ì˜¤ â€” AI í†µì‹  í›ˆë ¨</div>
      <div class="screen-desc">Gemini AIì™€ ì‹¤ì‹œê°„ ëª¨ìŠ¤ë¶€í˜¸ë¡œ êµì‹ í•©ë‹ˆë‹¤. ì„ë¬´ë¥¼ ì™„ìˆ˜í•˜ì„¸ìš”.</div>

      <!-- STEP 0: API Key input -->
      <div id="sc-step-apikey">
        <div class="api-setup">
          <div style="font-family:'Share Tech Mono';font-size:0.75rem;color:var(--text-dim);letter-spacing:0.1em;margin-bottom:20px;line-height:1.8;">
            â–¸ Google AI Studioì—ì„œ ë°œê¸‰í•œ Gemini API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”<br>
            <span style="font-size:0.65rem;color:rgba(255,179,0,0.5);">
              aistudio.google.com â†’ Get API key (ë¬´ë£Œ ì‚¬ìš© ê°€ëŠ¥)
            </span>
          </div>
          <div class="api-input-wrap">
            <input type="password" class="api-input" id="scApiKey" placeholder="AIza...">
            <button class="btn btn-amber" onclick="scSaveApiKey()">í™•ì¸</button>
          </div>
          <div style="margin:8px 0;">
            <button class="btn" onclick="scDiagnoseKey()" style="font-size:0.72rem;padding:8px 16px;">
              ğŸ” ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ í™•ì¸
            </button>
          </div>
          <div id="scDiagResult" style="font-family:'Share Tech Mono';font-size:0.72rem;color:var(--amber);letter-spacing:0.05em;margin-top:8px;line-height:1.8;"></div>
          <div style="font-size:0.7rem;color:var(--text-dim);font-family:'Share Tech Mono';letter-spacing:0.05em;margin-top:8px;">
            í‚¤ëŠ” ë¸Œë¼ìš°ì € ë‚´ì—ë§Œ ì €ì¥ë˜ë©° ì™¸ë¶€ë¡œ ì „ì†¡ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤
          </div>
        </div>
      </div>

      <!-- STEP 1: Scenario select -->
      <div id="sc-step-select" class="hidden">
        <div class="screen-desc" style="margin-bottom:12px;">ì‘ì „ì„ ì„ íƒí•˜ì„¸ìš”</div>
        <div class="scenario-cards" id="scCards"></div>
        <div class="btn-row" style="margin-top:8px;">
          <button class="btn btn-amber" id="scStartBtn" onclick="scBeginMission()" disabled>
            â–¶ ì‘ì „ ê°œì‹œ
          </button>
          <button class="btn" onclick="scChangeApiKey()">ğŸ”‘ API í‚¤ ë³€ê²½</button>
        </div>
      </div>

      <!-- ì»¤ìŠ¤í…€ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±ê¸° íŒ¨ë„ -->
      <div id="sc-step-creator" class="hidden">
        <div style="max-width:600px;">
          <div class="screen-title" style="margin-bottom:8px;">âœï¸ ë‚˜ë§Œì˜ ì‹œë‚˜ë¦¬ì˜¤ ë§Œë“¤ê¸°</div>
          <div class="screen-desc" style="margin-bottom:16px;">
            í•œêµ­ì–´ë¡œ ìƒí™©ì„ ì„¤ëª…í•˜ë©´ AIê°€ ì˜ì–´ ëª¨ìŠ¤ë¶€í˜¸ í†µì‹  ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤
          </div>

          <div style="margin-bottom:12px;">
            <div class="diff-label" style="margin-bottom:6px;">ì–´ë–¤ ìƒí™©ì¸ê°€ìš”? (ììœ ë¡­ê²Œ ì„¤ëª…)</div>
            <textarea id="scCreatorInput"
              style="width:100%;background:var(--panel);border:1px solid var(--border2);
                     border-radius:8px;padding:14px;color:var(--text);
                     font-family:'Noto Sans KR',sans-serif;font-size:0.85rem;
                     resize:vertical;min-height:100px;outline:none;line-height:1.7;"
              placeholder="ì˜ˆ: íƒœí‰ì–‘ ì „ìŸ ì¤‘ ì ìˆ˜í•¨ í•¨ì¥ìœ¼ë¡œì„œ ë³¸ë¶€ì— ì  í•¨ëŒ€ ë°œê²¬ ë³´ê³ ë¥¼ í•´ì•¼ í•œë‹¤. 3ê°€ì§€ ì •ë³´ë¥¼ ì „ë‹¬í•´ì•¼ í•œë‹¤."></textarea>
          </div>

          <div id="scCreatorStatus" style="font-family:'Share Tech Mono';font-size:0.78rem;
               color:var(--amber);letter-spacing:0.05em;min-height:24px;margin-bottom:12px;"></div>

          <div class="btn-row">
            <button class="btn btn-amber" onclick="scCreateScenario()" id="scCreateBtn">
              âš¡ AIë¡œ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±
            </button>
            <button class="btn" onclick="scCancelCreator()">ì·¨ì†Œ</button>
          </div>
        </div>
      </div>

      <!-- STEP 2: Comms interface -->
      <div id="sc-step-comms" class="hidden">

        <div class="comms-header">
          <div>
            <div class="comms-callsign" id="scCallsign">ALPHA-7</div>
            <div style="font-family:'Share Tech Mono';font-size:0.65rem;color:var(--text-dim);letter-spacing:0.1em;" id="scMissionTitle">â€”</div>
          </div>
          <div class="comms-status">
            <div class="status-dot" id="scStatusDot"></div>
            <span id="scStatusText">ëŒ€ê¸°ì¤‘</span>
          </div>
        </div>

        <!-- Mission progress -->
        <div class="mission-progress">
          <span>ì„ë¬´ ì§„í–‰ë„</span>
          <div class="mp-bar-wrap">
            <div class="mp-bar-fill" id="scProgressBar" style="width:0%"></div>
          </div>
          <span id="scProgressPct">0%</span>
        </div>

        <!-- Objectives -->
        <div class="objective-bar" id="scObjectives"></div>

        <!-- Signal visualizer (for incoming) -->
        <div style="background:var(--panel);border:1px solid var(--border2);border-radius:8px;padding:10px 14px;margin-bottom:12px;">
          <div style="font-family:'Share Tech Mono';font-size:0.65rem;color:var(--text-dim);letter-spacing:0.2em;margin-bottom:6px;">
            â–¸ ìˆ˜ì‹  ì‹ í˜¸
          </div>
          <div class="signal-wave" id="scSignalWave"></div>
          <div style="font-family:'Share Tech Mono';font-size:0.7rem;color:var(--text-dim);margin-top:4px;" id="scRcvStatus">â€”</div>
        </div>

        <!-- Intel briefing panel -->
        <div class="intel-panel" id="scIntelPanel" style="display:none;">
          <div class="intel-panel-title">
            <span class="intel-panel-toggle" onclick="toggleIntelPanel()">
              â–¸ <span id="scIntelToggleLabel">ë‚´ê°€ ì „ë‹¬í•´ì•¼ í•  ì •ë³´</span>
              <span id="scIntelToggleIcon" style="margin-left:4px;">â–¾</span>
            </span>
          </div>
          <div id="scIntelRows"></div>
        </div>

        <!-- Message log -->
        <div class="msg-log" id="scMsgLog">
          <div class="msg-entry system">
            <div class="msg-meta">SYSTEM</div>
            êµì‹  ì¤€ë¹„ ì™„ë£Œ. ì²« ë²ˆì§¸ ìˆ˜ì‹ ì„ ê¸°ë‹¤ë¦¬ì„¸ìš”.
          </div>
        </div>

        <!-- Transmit panel -->
        <div class="tx-panel" id="scTxPanel">
          <div style="font-family:'Share Tech Mono';font-size:0.65rem;color:var(--text-dim);letter-spacing:0.2em;margin-bottom:8px;display:flex;justify-content:space-between;">
            <span>â–¸ ì†¡ì‹  â€” ìŠ¤í˜ì´ìŠ¤ë°”ë¡œ ì…ë ¥</span>
            <span id="scWordTimer" style="color:var(--amber);"></span>
          </div>

          <!-- í˜„ì¬ ì…ë ¥ ì¤‘ì¸ ëª¨ìŠ¤ë¶€í˜¸ -->
          <div class="tx-morse-live" id="scTxMorse">â€”</div>

          <!-- ì™„ì„±ëœ ê¸€ìë“¤ -->
          <div class="word-buffer" id="scWordBuffer"></div>

          <!-- ì „ì²´ ì…ë ¥ ë¬¸ì¥ ë¯¸ë¦¬ë³´ê¸° -->
          <div class="tx-decoded-live" id="scTxSentence" style="font-size:0.85rem;"></div>

          <div style="display:flex;gap:10px;margin-top:12px;align-items:center;">
            <div class="key-btn" id="scKeyBtn"
              onmousedown="scKeyDown()" onmouseup="scKeyUp()"
              ontouchstart="scKeyDown()" ontouchend="scKeyUp()"
              style="font-size:0.7rem;padding:14px 28px;">
              â¬› SPACE â€” ëª¨ìŠ¤ë¶€í˜¸ ì…ë ¥
            </div>
            <button class="btn btn-amber" onclick="scSendMessage()" id="scSendBtn" disabled>
              â–¶ ì „ì†¡ (Enter)
            </button>
            <button class="btn" onclick="scClearTx()">âœ• ì§€ìš°ê¸°</button>
          </div>
          <div class="key-hint">
            ì§§ê²Œ = Â· (ì ) &nbsp;|&nbsp; ê¸¸ê²Œ = â€” (ì„ ) &nbsp;|&nbsp; 
            ìŠ¤í˜ì´ìŠ¤ë°” ë–¼ê³  ì ì‹œ ê¸°ë‹¤ë¦¬ë©´ ê¸€ì í™•ì • &nbsp;|&nbsp; Enter = ì „ì†¡
          </div>
        </div>

        <div class="btn-row">
          <button class="btn" onclick="scReplayLast()">â†º ë§ˆì§€ë§‰ ì‹ í˜¸ ë‹¤ì‹œ ë“£ê¸°</button>
          <button class="btn btn-amber" onclick="scAbortMission()" style="margin-left:auto;">â¬› ì‘ì „ ì¤‘ë‹¨</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Result overlay -->
<div class="result-overlay" id="resultOverlay">
  <div class="result-box">
    <div class="result-title" id="resultTitle">MISSION COMPLETE</div>
    <div class="result-score" id="resultScore">0</div>
    <div class="result-sub" id="resultSub"></div>
    <div class="btn-row" style="justify-content:center;">
      <button class="btn btn-primary" onclick="closeResult()">í™•ì¸</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MORSE CODE DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MORSE = {
  'A':'.-',    'B':'-...',  'C':'-.-.',  'D':'-..',
  'E':'.',     'F':'..-.',  'G':'--.',   'H':'....',
  'I':'..',    'J':'.---',  'K':'-.-',   'L':'.-..',
  'M':'--',    'N':'-.',    'O':'---',   'P':'.--.',
  'Q':'--.-',  'R':'.-.',   'S':'...',   'T':'-',
  'U':'..-',   'V':'...-',  'W':'.--',   'X':'-..-',
  'Y':'-.--',  'Z':'--..',
  '0':'-----', '1':'.----', '2':'..---', '3':'...--',
  '4':'....-', '5':'.....', '6':'-....', '7':'--...',
  '8':'---..',  '9':'----.'
};

// Reverse lookup
const MORSE_REV = {};
Object.entries(MORSE).forEach(([c,m])=>MORSE_REV[m]=c);

const ALL_CHARS = Object.keys(MORSE);
const ALPHA = ALL_CHARS.filter(c => isNaN(c));
const NUMS  = ALL_CHARS.filter(c => !isNaN(c));

const EASY_CHARS  = ['E','T','I','A','N','M','S','O'];
const MED_CHARS   = [...ALPHA.slice(0,18),...NUMS.slice(0,5)];
const HARD_CHARS  = ALL_CHARS;

let difficulty = 'easy';
let totalScore = 0;
let totalStreak= 0;

// Words for word challenge
const WORDS = [
  'SOS','CAT','DOG','HAM','KEY','ANT','BEE','COD','EEL','FIG',
  'GEM','HIT','ICE','JAR','KIT','LOG','MAP','NET','OAK','PAN',
  'ACE','BAT','CUP','DIM','EGG','FAN','GAS','HOP','INK','JAM',
  'HELLO','WORLD','MORSE','RADIO','SIGNAL','ALPHA','BRAVO',
  'ECHO','FOXTROT','GOLF','HOTEL','INDIA','JULIET','KILO',
  'LIME','MIKE','OSCAR','PAPA','QUEBEC','ROMEO','SIERRA',
  'TANGO','UNIFORM','VICTOR','WHISKEY','XRAY','YANKEE','ZULU'
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUDIO ENGINE â€” ì¤‘ì²© ë°©ì§€ ì™„ì „ ì¬ì‘ì„±
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let audioCtx = null;
// ë°œì‹ ìš©: í‚¤ ëˆ„ë¥´ëŠ” ë™ì•ˆ ìœ ì§€ë˜ëŠ” ë‹¨ì¼ oscillator
let keyOsc   = null;
let keyGain  = null;

function getAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

// ìˆ˜ì‹ /ì¬ìƒìš© â€” ì§§ì€ ë‹¨ë°œì„± ë¹„í”„ (ìƒˆ oscillator ë§¤ë²ˆ ìƒì„±í•˜ë˜ ì¦‰ì‹œ ìë™ì¢…ë£Œ)
function beep(duration, frequency=700, vol=0.4) {
  const ctx = getAudio();
  const osc = ctx.createOscillator();
  const g   = ctx.createGain();
  osc.connect(g);
  g.connect(ctx.destination);
  osc.type = 'sine';
  osc.frequency.value = frequency;
  const t = ctx.currentTime;
  g.gain.setValueAtTime(0, t);
  g.gain.linearRampToValueAtTime(vol, t + 0.008);
  g.gain.setValueAtTime(vol, t + duration - 0.008);
  g.gain.linearRampToValueAtTime(0, t + duration);
  osc.start(t);
  osc.stop(t + duration);
}

// ë°œì‹  í‚¤ ëˆ„ë¦„ ì‹œì‘ â€” oscillator í•˜ë‚˜ ì¼œë‘ê¸°
function keyToneStart() {
  keyToneStop(); // í˜¹ì‹œ ë‚¨ì•„ìˆëŠ” ê±° ë¨¼ì € ì •ë¦¬
  const ctx = getAudio();
  keyOsc  = ctx.createOscillator();
  keyGain = ctx.createGain();
  keyOsc.connect(keyGain);
  keyGain.connect(ctx.destination);
  keyOsc.type = 'sine';
  keyOsc.frequency.value = 700;
  keyGain.gain.setValueAtTime(0, ctx.currentTime);
  keyGain.gain.linearRampToValueAtTime(0.4, ctx.currentTime + 0.01);
  keyOsc.start();
}

// ë°œì‹  í‚¤ ë—„ ë•Œ â€” oscillator ë¶€ë“œëŸ½ê²Œ ì¢…ë£Œ
function keyToneStop() {
  if (!keyOsc) return;
  const ctx = getAudio();
  try {
    keyGain.gain.setValueAtTime(keyGain.gain.value, ctx.currentTime);
    keyGain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.015);
    keyOsc.stop(ctx.currentTime + 0.02);
  } catch(e) {}
  keyOsc  = null;
  keyGain = null;
}

function playMorse(morseStr, speed=1, callback=null) {
  // Speed multiplier: 1 = normal, 2 = fast
  const dot  = 0.08 / speed;
  const dash = dot * 3;
  const gap  = dot;
  const charGap = dot * 3;

  let t = 0;
  for(let i=0; i<morseStr.length; i++) {
    const sym = morseStr[i];
    const delay = t;
    if(sym === '.') {
      setTimeout(()=>beep(dot, 700), delay*1000);
      t += dot + gap;
    } else if(sym === '-') {
      setTimeout(()=>beep(dash, 700), delay*1000);
      t += dash + gap;
    } else if(sym === ' ') {
      t += charGap;
    }
  }

  const totalTime = t * 1000 + 200;
  if(callback) setTimeout(callback, totalTime);
  return totalTime;
}

function playMorseWithVisual(morseStr, signalContainer, speed=1, callback=null) {
  signalContainer.innerHTML = '';

  const segs = [];
  for(let ch of morseStr) {
    if(ch==='.' || ch==='-') segs.push(ch);
  }

  segs.forEach(s=>{
    const el = document.createElement('div');
    el.className = s==='.' ? 'signal-dot' : 'signal-dash';
    signalContainer.appendChild(el);
  });

  const dot  = 80 / speed;
  const dash = dot * 3;
  const gap  = dot;

  let t = 0;
  let si = 0;
  for(let ch of morseStr) {
    if(ch==='.' || ch==='-') {
      const idx = si;
      const dur = ch==='.' ? dot : dash;
      setTimeout(()=>{
        const el = signalContainer.children[idx];
        if(el) {
          el.classList.add('lit');
          if(ch==='.') beep(dot/1000, 700);
          else beep(dash/1000, 700);
          setTimeout(()=>el.classList.remove('lit'), dur);
        }
      }, t);
      t += dur + gap;
      si++;
    } else {
      t += gap * 2;
    }
  }

  const total = t + 300;
  if(callback) setTimeout(callback, total);
  return total;
}

function getSpeed() {
  if(difficulty==='easy') return 0.7;
  if(difficulty==='mid')  return 1.0;
  return 1.6;
}

function getCharPool() {
  if(difficulty==='easy') return EASY_CHARS;
  if(difficulty==='mid')  return MED_CHARS;
  return HARD_CHARS;
}

function randomChar(pool) {
  pool = pool || getCharPool();
  return pool[Math.floor(Math.random()*pool.length)];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('screen-'+id).classList.add('active');
  const nb = document.getElementById('nav-'+id);
  if(nb) nb.classList.add('active');

  // Init screens
  if(id==='study') buildRefTable();
  if(id==='receive') rxReset();
  if(id==='transmit') txReset();
  if(id==='word') wordReset();
  if(id==='challenge') chReset();
  if(id==='scenario') scInit();
}

function setDifficulty(d, btn) {
  difficulty = d;
  document.querySelectorAll('.diff-btn').forEach(b=>{
    b.className = 'diff-btn';
  });
  btn.classList.add('active-'+d);

  // Reset current game if active
  rxReset();
  txReset();
}

function updateHeaderStats() {
  document.getElementById('headerScore').textContent = totalScore;
  document.getElementById('headerStreak').textContent = totalStreak;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STUDY â€” REFERENCE TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildRefTable() {
  const alphaDiv = document.getElementById('refAlpha');
  const numsDiv  = document.getElementById('refNums');
  alphaDiv.innerHTML = '';
  numsDiv.innerHTML = '';

  ALPHA.forEach(ch=>{
    const card = document.createElement('div');
    card.className = 'ref-card';
    card.innerHTML = `<div class="ref-char">${ch}</div><div class="ref-morse">${MORSE[ch]}</div>`;
    card.onclick = ()=>{ playMorse(MORSE[ch], 0.8); highlightCard(card); };
    alphaDiv.appendChild(card);
  });

  NUMS.forEach(ch=>{
    const card = document.createElement('div');
    card.className = 'ref-card';
    card.innerHTML = `<div class="ref-char">${ch}</div><div class="ref-morse">${MORSE[ch]}</div>`;
    card.onclick = ()=>{ playMorse(MORSE[ch], 0.8); highlightCard(card); };
    numsDiv.appendChild(card);
  });
}

function highlightCard(card) {
  document.querySelectorAll('.ref-card').forEach(c=>c.style.borderColor='');
  card.style.borderColor = 'var(--green)';
  card.style.background  = 'var(--green-glow)';
  setTimeout(()=>{
    card.style.borderColor = '';
    card.style.background  = '';
  }, 800);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RECEIVE MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let rxState = {
  active: false,
  mode: 'char',         // 'char' | 'word'
  currentChar: null,    // ê¸€ì ëª¨ë“œìš©
  currentWord: null,    // ë‹¨ì–´ ëª¨ë“œìš©
  wordLetterIdx: 0,     // ë‹¨ì–´ ëª¨ë“œ: í˜„ì¬ ë“¤ë ¤ì£¼ëŠ” ê¸€ì ì¸ë±ìŠ¤
  score:0, streak:0, correct:0, wrong:0,
  playing: false
};

function rxSetMode(mode) {
  rxState.mode = mode;
  const charBtn = document.getElementById('rxModeChar');
  const wordBtn = document.getElementById('rxModeWord');

  // ë²„íŠ¼ ìŠ¤íƒ€ì¼ í† ê¸€
  if (mode === 'char') {
    charBtn.style.cssText = 'padding:6px 14px;font-size:0.72rem;border-color:var(--green);color:var(--green);background:var(--green-glow);';
    wordBtn.style.cssText = 'padding:6px 14px;font-size:0.72rem;border-color:var(--border);color:var(--text-dim);background:transparent;';
    document.getElementById('rxInput').maxLength = 1;
    document.getElementById('rxInput').placeholder = '?';
    document.getElementById('rxWordLetters').style.display = 'none';
  } else {
    wordBtn.style.cssText = 'padding:6px 14px;font-size:0.72rem;border-color:var(--green);color:var(--green);background:var(--green-glow);';
    charBtn.style.cssText = 'padding:6px 14px;font-size:0.72rem;border-color:var(--border);color:var(--text-dim);background:transparent;';
    document.getElementById('rxInput').maxLength = 20;
    document.getElementById('rxWordLetters').style.display = 'flex';
  }

  // í•­ìƒ ë¦¬ì…‹ í›„ ì¦‰ì‹œ ì‹œì‘
  const prevActive = rxState.active;
  rxState.active = false;
  rxState.currentChar = null;
  rxState.currentWord = null;
  document.getElementById('rxInput').value = '';
  document.getElementById('rxInput').disabled = false;
  document.getElementById('rxFeedback').textContent = '';
  document.getElementById('rxHintBox').classList.add('hidden');
  document.getElementById('rxSignals').innerHTML = '';
  document.getElementById('rxWordLetters').innerHTML = '';
  document.getElementById('rxStartBtn').textContent = 'â†º ë‹¤ìŒ ë¬¸ì œ';

  // ë°”ë¡œ ìƒˆ ë¬¸ì œ ì‹œì‘
  rxState.active = true;
  rxNextChar();
}

function rxReset() {
  rxState = {active:false, mode: rxState.mode || 'char',
             currentChar:null, currentWord:null, wordLetterIdx:0,
             score:0, streak:0, correct:0, wrong:0, playing:false};
  document.getElementById('rxScore').textContent   = 0;
  document.getElementById('rxStreak').textContent  = 0;
  document.getElementById('rxCorrect').textContent = 0;
  document.getElementById('rxWrong').textContent   = 0;
  document.getElementById('rxInput').value = '';
  document.getElementById('rxInput').disabled = true;
  document.getElementById('rxFeedback').textContent = '';
  document.getElementById('rxFeedback').className   = 'feedback';
  document.getElementById('rxHintBox').classList.add('hidden');
  document.getElementById('rxHintBtn').disabled  = true;
  document.getElementById('rxHintBtn2').disabled = true;
  document.getElementById('rxReplayBtn').disabled = true;
  document.getElementById('rxSignals').innerHTML = '';
  document.getElementById('rxWordLetters').innerHTML = '';
}

function rxStart() {
  rxState.active = true;
  document.getElementById('rxStartBtn').textContent = 'â†º ë‹¤ìŒ ë¬¸ì œ';
  rxNextChar();
}

function rxNextChar() {
  rxState.playing = true;
  const inp = document.getElementById('rxInput');
  inp.value = '';
  inp.disabled = false;
  inp.className = 'answer-input';
  document.getElementById('rxFeedback').textContent = '';
  document.getElementById('rxHintBox').classList.add('hidden');
  document.getElementById('rxHintBtn').disabled  = false;
  document.getElementById('rxHintBtn2').disabled = false;
  document.getElementById('rxReplayBtn').disabled = false;
  document.getElementById('rxDisplay').className = 'morse-display';

  if (rxState.mode === 'char') {
    // â”€â”€ ê¸€ì ëª¨ë“œ: ëœë¤ ë¬¸ì 1ê°œ
    rxState.currentChar = randomChar(getCharPool());
    rxState.currentWord = null;
    document.getElementById('rxWordLetters').style.display = 'none';
    inp.maxLength = 1;
    inp.placeholder = '?';
    rxPlay();
  } else {
    // â”€â”€ ë‹¨ì–´ ëª¨ë“œ: WORDS ëª©ë¡ì—ì„œ ëœë¤ ë‹¨ì–´
    const pool = getCharPool();
    // ë‚œì´ë„ì— ë”°ë¼ ë‹¨ì–´ ê¸¸ì´ ì œí•œ
    let wordPool;
    if (difficulty === 'easy')      wordPool = WORDS.filter(w => w.length <= 3);
    else if (difficulty === 'mid')  wordPool = WORDS.filter(w => w.length <= 5);
    else                            wordPool = WORDS;
    rxState.currentWord = wordPool[Math.floor(Math.random() * wordPool.length)];
    rxState.currentChar = null;
    rxState.wordLetterIdx = 0;

    inp.maxLength = rxState.currentWord.length;
    inp.placeholder = '?'.repeat(rxState.currentWord.length);

    // ë‹¨ì–´ ê¸€ì ë°•ìŠ¤ ë Œë”ë§ (ëª¨ë‘ ë¹ˆì¹¸ìœ¼ë¡œ)
    renderRxWordLetters();
    document.getElementById('rxWordLetters').style.display = 'flex';

    // ë‹¨ì–´ ì „ì²´ë¥¼ í•œ ê¸€ìì”© ì°¨ë¡€ë¡œ ì¬ìƒ
    rxPlayWord();
  }
  inp.focus();
}

function renderRxWordLetters(revealedCount) {
  const word = rxState.currentWord;
  const n    = revealedCount || 0;
  const container = document.getElementById('rxWordLetters');
  container.innerHTML = word.split('').map((ch, i) => {
    let cls = 'word-letter';
    if (i < n) cls += ' done';
    return `<div class="${cls}" id="rxwl-${i}">${i < n ? ch : '?'}</div>`;
  }).join('');
}

// ë‹¨ì–´ë¥¼ ê¸€ìë³„ë¡œ ìˆœì„œëŒ€ë¡œ ì¬ìƒ
function rxPlayWord(startIdx) {
  const word = rxState.currentWord;
  if (!word) return;
  const speed = getSpeed();
  const dot   = 90 / speed;
  const dash  = dot * 3;
  const gap   = dot;

  // ê° ê¸€ì ì‚¬ì´ ê°„ê²© (ê¸€ì ê°„ê²© = 3ë°° gap)
  const letterGap = dot * 7;   // ê¸€ì ê°„ê²©
  const wordContainer = document.getElementById('rxSignals');
  wordContainer.innerHTML = '';

  let t = 0;
  for (let i = 0; i < word.length; i++) {
    const ch    = word[i];
    const morse = MORSE[ch];
    if (!morse) continue;

    // ê¸€ì ì¸ë±ìŠ¤ ê°•ì¡° í‘œì‹œ ì˜ˆì•½
    const liIdx = i;
    setTimeout(() => {
      document.querySelectorAll('.word-letter').forEach((el, idx) => {
        el.style.boxShadow = idx === liIdx ? '0 0 12px var(--green)' : '';
      });
    }, t);

    // ì‹¬ë³¼ ì¬ìƒ
    for (let sym of morse) {
      const dur = sym === '.' ? dot : dash;
      const symT = t;
      setTimeout(() => {
        beep(dur / 1000, 700);
        // ì‹ í˜¸ ì‹œê°í™”: ë‹¨ì¼ ìš”ì†Œ ê¹œë°•ì„
        wordContainer.innerHTML = `<div class="${sym==='.'?'signal-dot':'signal-dash'} lit"
          style="opacity:1;box-shadow:0 0 12px var(--green),0 0 24px rgba(57,255,90,0.5)"></div>`;
        setTimeout(() => { wordContainer.innerHTML = ''; }, dur);
      }, symT);
      t += dur + gap;
    }
    t += letterGap;  // ê¸€ì ê°„ê²©
  }

  // ëë‚˜ë©´ ë°•ìŠ¤ ê°•ì¡° ì œê±°
  setTimeout(() => {
    document.querySelectorAll('.word-letter').forEach(el => el.style.boxShadow = '');
  }, t);
}

function rxPlay() {
  if (rxState.mode === 'word') {
    rxPlayWord();
    return;
  }
  if (!rxState.currentChar) return;
  const morse = MORSE[rxState.currentChar];
  const container = document.getElementById('rxSignals');
  playMorseWithVisual(morse, container, getSpeed());
}

function rxShowHint() {
  const hintBox = document.getElementById('rxHintBox');
  if (rxState.mode === 'char' && rxState.currentChar) {
    hintBox.textContent = `â–¸ ëª¨ìŠ¤ë¶€í˜¸: ${MORSE[rxState.currentChar]}`;
    hintBox.classList.remove('hidden');
  } else if (rxState.mode === 'word' && rxState.currentWord) {
    const morseStr = rxState.currentWord.split('').map(c => MORSE[c] || '?').join('  ');
    hintBox.innerHTML = `â–¸ ${rxState.currentWord}: ${morseStr}`;
    hintBox.classList.remove('hidden');
  }
}

function rxCheck(val) {
  if (!rxState.active) return;
  val = val.toUpperCase().trim();
  if (!val) return;

  const dispEl = document.getElementById('rxDisplay');
  const inp    = document.getElementById('rxInput');
  const fb     = document.getElementById('rxFeedback');

  if (rxState.mode === 'char') {
    // â”€â”€ ê¸€ì ëª¨ë“œ
    if (val.length < 1) return;
    const correct = rxState.currentChar;
    const answer  = val[val.length - 1];  // ë§ˆì§€ë§‰ ì…ë ¥ ê¸€ì

    if (answer === correct) {
      rxState.score   += diffPoints();
      rxState.streak  += 1; rxState.correct += 1;
      totalScore += diffPoints(); totalStreak += 1;
      inp.className = 'answer-input correct';
      dispEl.classList.add('flash-correct');
      fb.textContent = `âœ“ ì •ë‹µ! "${correct}" = ${MORSE[correct]}   (+${diffPoints()}ì )`;
      fb.className   = 'feedback ok';
      setTimeout(() => dispEl.classList.remove('flash-correct'), 500);
    } else {
      rxState.score  = Math.max(0, rxState.score - 5);
      rxState.streak = 0; rxState.wrong += 1; totalStreak = 0;
      inp.className = 'answer-input wrong';
      dispEl.classList.add('flash-wrong');
      fb.textContent = `âœ— ì˜¤ë‹µ. ì •ë‹µì€ "${correct}" = ${MORSE[correct]}`;
      fb.className   = 'feedback err';
      setTimeout(() => dispEl.classList.remove('flash-wrong'), 500);
      playMorse(MORSE[correct], 0.7);
    }
    updateRxStats(); updateHeaderStats();
    setTimeout(() => { if (rxState.active) rxNextChar(); }, 1500);

  } else {
    // â”€â”€ ë‹¨ì–´ ëª¨ë“œ: Enter í‚¤ë¡œ ì œì¶œ
    const correct = rxState.currentWord;
    if (!correct) return;

    if (val === correct) {
      const pts = diffPoints() * correct.length;
      rxState.score   += pts;
      rxState.streak  += 1; rxState.correct += 1;
      totalScore += pts; totalStreak += 1;
      inp.className = 'answer-input correct';
      dispEl.classList.add('flash-correct');
      fb.textContent = `âœ“ ì •ë‹µ! "${correct}"   (+${pts}ì )`;
      fb.className   = 'feedback ok';
      // ëª¨ë“  ê¸€ì ì •ë‹µ í‘œì‹œ
      correct.split('').forEach((ch, i) => {
        const el = document.getElementById('rxwl-' + i);
        if (el) { el.textContent = ch; el.classList.add('done'); el.classList.remove('error'); }
      });
      setTimeout(() => dispEl.classList.remove('flash-correct'), 500);
    } else {
      rxState.score  = Math.max(0, rxState.score - 5);
      rxState.streak = 0; rxState.wrong += 1; totalStreak = 0;
      inp.className = 'answer-input wrong';
      dispEl.classList.add('flash-wrong');
      // ê¸€ìë³„ ë§ê³  í‹€ë¦¼ í‘œì‹œ
      correct.split('').forEach((ch, i) => {
        const el = document.getElementById('rxwl-' + i);
        if (!el) return;
        el.textContent = ch;
        if (val[i] === ch) { el.classList.add('done'); }
        else               { el.classList.add('error'); }
      });
      fb.textContent = `âœ— ì˜¤ë‹µ. ì •ë‹µ: "${correct}"`;
      fb.className   = 'feedback err';
      setTimeout(() => dispEl.classList.remove('flash-wrong'), 500);
    }
    updateRxStats(); updateHeaderStats();
    setTimeout(() => { if (rxState.active) rxNextChar(); }, 2000);
  }
}

function updateRxStats() {
  document.getElementById('rxScore').textContent   = rxState.score;
  document.getElementById('rxStreak').textContent  = rxState.streak;
  document.getElementById('rxCorrect').textContent = rxState.correct;
  document.getElementById('rxWrong').textContent   = rxState.wrong;
}

function diffPoints() {
  if(difficulty==='easy') return 5;
  if(difficulty==='mid')  return 10;
  return 20;
}

// Input listener for receive mode
document.addEventListener('DOMContentLoaded', ()=>{
  const rxInp = document.getElementById('rxInput');
  rxInp.addEventListener('input', e=>{
    const v = e.target.value.toUpperCase();
    rxInp.value = v;
    // ê¸€ì ëª¨ë“œ: 1ê¸€ì ì…ë ¥ë˜ë©´ ë°”ë¡œ ì²´í¬
    if (rxState.mode === 'char' && v.length >= 1) rxCheck(v);
    // ë‹¨ì–´ ëª¨ë“œ: ì…ë ¥ ê¸¸ì´ê°€ ëª©í‘œ ë‹¨ì–´ ê¸¸ì´ì™€ ê°™ìœ¼ë©´ ìë™ ì²´í¬
    if (rxState.mode === 'word' && rxState.currentWord && v.length >= rxState.currentWord.length) rxCheck(v);
  });
  rxInp.addEventListener('keydown', e=>{
    if (e.key === 'Enter') {
      e.preventDefault();
      if (rxInp.value) rxCheck(rxInp.value);
    }
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRANSMIT MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let txState = {
  active: false,
  currentChar: null,
  score:0, streak:0, correct:0, wrong:0,
  inputMorse: '',
  keyDownTime: null,
  keyDown: false,
  dotThreshold: 200  // ms
};

function txReset() {
  txState = {active:false, currentChar:null, score:0, streak:0, correct:0, wrong:0,
             inputMorse:'', keyDownTime:null, keyDown:false, dotThreshold:200};
  document.getElementById('txScore').textContent   = 0;
  document.getElementById('txStreak').textContent  = 0;
  document.getElementById('txCorrect').textContent = 0;
  document.getElementById('txWrong').textContent   = 0;
  document.getElementById('txTarget').textContent  = '?';
  document.getElementById('txMorseInput').textContent = 'â€”';
  document.getElementById('txDecoded').textContent    = 'ì…ë ¥ ëŒ€ê¸°ì¤‘';
  document.getElementById('txFeedback').textContent   = '';
  document.getElementById('txFeedback').className     = 'feedback';
  document.getElementById('txSubmitBtn').disabled = true;
  document.getElementById('txAnswerBtn').disabled = true;
}

function txStart() {
  txState.active = true;
  document.getElementById('txStartBtn').textContent = 'â†º ë‹¤ìŒ ë¬¸ì œ';
  document.getElementById('txSubmitBtn').disabled = false;
  document.getElementById('txAnswerBtn').disabled = false;
  txNextChar();
}

function txNextChar() {
  txState.currentChar = randomChar(getCharPool());
  txState.inputMorse  = '';
  document.getElementById('txTarget').textContent = txState.currentChar;
  document.getElementById('txMorseInput').textContent = 'â€”';
  document.getElementById('txDecoded').textContent    = 'ì…ë ¥ ëŒ€ê¸°ì¤‘';
  document.getElementById('txFeedback').textContent   = '';
  document.getElementById('txFeedback').className     = 'feedback';
}

function txKeyDown() {
  if(!txState.active) return;
  if(txState.keyDown) return;
  txState.keyDown = true;
  txState.keyDownTime = Date.now();
  document.getElementById('txKeyVisual').classList.add('active');
  keyToneStart();
}

function txKeyUp() {
  if(!txState.active || !txState.keyDown) return;
  txState.keyDown = false;
  keyToneStop();
  document.getElementById('txKeyVisual').classList.remove('active');

  const dur = Date.now() - txState.keyDownTime;
  const sym = dur < txState.dotThreshold ? '.' : '-';
  txState.inputMorse += sym;

  const display = document.getElementById('txMorseInput');
  display.textContent = txState.inputMorse;

  // Try decode
  const decoded = MORSE_REV[txState.inputMorse] || '?';
  document.getElementById('txDecoded').textContent = decoded !== '?' ? `â†’ ${decoded}` : '(ë¯¸ì™„ì„±)';
}

function txClear() {
  txState.inputMorse = '';
  document.getElementById('txMorseInput').textContent = 'â€”';
  document.getElementById('txDecoded').textContent    = 'ì…ë ¥ ëŒ€ê¸°ì¤‘';
}

function txSubmit() {
  if(!txState.active || !txState.currentChar) return;
  const decoded = MORSE_REV[txState.inputMorse];
  const correct = txState.currentChar;
  const fb = document.getElementById('txFeedback');

  if(decoded === correct) {
    txState.score   += diffPoints();
    txState.streak  += 1;
    txState.correct += 1;
    totalScore  += diffPoints();
    totalStreak += 1;
    fb.textContent = `âœ“ ì •ë‹µ! "${correct}" = ${MORSE[correct]}   (+${diffPoints()}ì )`;
    fb.className   = 'feedback ok';
    playMorse(MORSE[correct], 1);
  } else {
    txState.score  = Math.max(0, txState.score - 5);
    txState.streak = 0;
    txState.wrong += 1;
    totalStreak = 0;
    const got = decoded || `?? (${txState.inputMorse})`;
    fb.textContent = `âœ— ì˜¤ë‹µ. ì…ë ¥: ${got} / ì •ë‹µ: ${correct} = ${MORSE[correct]}`;
    fb.className   = 'feedback err';
    playMorse(MORSE[correct], 0.7);
  }

  updateTxStats();
  updateHeaderStats();

  setTimeout(()=>{ if(txState.active) txNextChar(); }, 1800);
}

function txShowAnswer() {
  if(!txState.currentChar) return;
  const ch = txState.currentChar;
  const fb = document.getElementById('txFeedback');
  fb.textContent = `ì •ë‹µ: "${ch}" = ${MORSE[ch]}`;
  fb.className   = 'feedback info';
  playMorse(MORSE[ch], 0.8);
}

function updateTxStats() {
  document.getElementById('txScore').textContent   = txState.score;
  document.getElementById('txStreak').textContent  = txState.streak;
  document.getElementById('txCorrect').textContent = txState.correct;
  document.getElementById('txWrong').textContent   = txState.wrong;
}

// Keyboard listeners
document.addEventListener('keydown', e=>{
  // Transmit mode
  if(document.getElementById('screen-transmit').classList.contains('active')) {
    if(e.code==='Space' && !e.repeat) { e.preventDefault(); txKeyDown(); }
    if(e.code==='Enter') { e.preventDefault(); txSubmit(); }
    if(e.code==='Backspace') { e.preventDefault(); txClear(); }
  }
  // Word mode
  if(document.getElementById('screen-word').classList.contains('active')) {
    if(e.code==='Space' && !e.repeat) { e.preventDefault(); wordKeyDown(); }
    if(e.code==='Enter') { e.preventDefault(); wordSubmitLetter(); }
    if(e.code==='Backspace') { e.preventDefault(); wordClear(); }
  }
  // Receive mode
  if(document.getElementById('screen-challenge').classList.contains('active')) {
    const inp = document.getElementById('chInput');
    if(document.activeElement !== inp) inp.focus();
  }
  // Scenario mode
  if(document.getElementById('screen-scenario').classList.contains('active')) {
    if(e.code==='Space' && !e.repeat) { e.preventDefault(); scKeyDown(); }
    if(e.code==='Enter') { e.preventDefault(); scSendMessage(); }
    if(e.code==='Backspace') { e.preventDefault(); scClearTx(); }
  }
});

document.addEventListener('keyup', e=>{
  if(document.getElementById('screen-transmit').classList.contains('active')) {
    if(e.code==='Space') { e.preventDefault(); txKeyUp(); }
  }
  if(document.getElementById('screen-word').classList.contains('active')) {
    if(e.code==='Space') { e.preventDefault(); wordKeyUp(); }
  }
  // Scenario mode
  if(document.getElementById('screen-scenario').classList.contains('active')) {
    if(e.code==='Space') { e.preventDefault(); scKeyUp(); }
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WORD MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let wordState = {
  word: '',
  letterIdx: 0,
  inputMorse: '',
  keyDownTime: null,
  keyDown: false,
  dotThreshold: 200,
  history: [],
  active: false
};
let wordBeepInterval = null;

function wordReset() {
  wordState = {word:'', letterIdx:0, inputMorse:'', keyDownTime:null, keyDown:false, dotThreshold:200, history:[], active:false};
  document.getElementById('wordLetters').innerHTML = '';
  document.getElementById('wordMorseInput').textContent = 'â€”';
  document.getElementById('wordCurrentMorse').textContent = 'â€”';
  document.getElementById('wordFeedback').textContent = '';
  document.getElementById('wordSubmitBtn').disabled = true;
}

function wordStart() {
  wordState.active = true;
  wordState.inputMorse = '';
  wordState.letterIdx  = 0;
  wordState.keyDown = false;

  const idx = Math.floor(Math.random()*WORDS.length);
  wordState.word = WORDS[idx];

  renderWordLetters();
  document.getElementById('wordMorseInput').textContent = 'â€”';
  document.getElementById('wordFeedback').textContent = '';
  document.getElementById('wordFeedback').className   = 'feedback';
  document.getElementById('wordSubmitBtn').disabled = false;
  updateWordCurrentMorse();
}

function renderWordLetters() {
  const container = document.getElementById('wordLetters');
  container.innerHTML = '';
  for(let i=0; i<wordState.word.length; i++) {
    const el = document.createElement('div');
    el.className = 'word-letter';
    el.id = `wl-${i}`;
    if(i===0) el.classList.add('current');
    el.textContent = wordState.word[i];
    container.appendChild(el);
  }
}

function updateWordCurrentMorse() {
  if(wordState.letterIdx < wordState.word.length) {
    const ch = wordState.word[wordState.letterIdx];
    document.getElementById('wordCurrentMorse').textContent =
      `ëª©í‘œ: "${ch}" = ${MORSE[ch]}`;
  }
}

function wordKeyDown() {
  if(!wordState.active) return;
  if(wordState.keyDown) return;
  wordState.keyDown = true;
  wordState.keyDownTime = Date.now();
  document.getElementById('wordKeyVisual').classList.add('active');
  keyToneStart();
}

function wordKeyUp() {
  if(!wordState.active || !wordState.keyDown) return;
  wordState.keyDown = false;
  keyToneStop();
  document.getElementById('wordKeyVisual').classList.remove('active');

  const dur = Date.now() - wordState.keyDownTime;
  const sym = dur < wordState.dotThreshold ? '.' : '-';
  wordState.inputMorse += sym;
  document.getElementById('wordMorseInput').textContent = wordState.inputMorse;
}

function wordClear() {
  wordState.inputMorse = '';
  document.getElementById('wordMorseInput').textContent = 'â€”';
}

function wordSubmitLetter() {
  if(!wordState.active) return;
  if(wordState.letterIdx >= wordState.word.length) return;

  const targetCh = wordState.word[wordState.letterIdx];
  const decoded  = MORSE_REV[wordState.inputMorse];
  const letterEl = document.getElementById(`wl-${wordState.letterIdx}`);
  const fb = document.getElementById('wordFeedback');

  if(decoded === targetCh) {
    letterEl.classList.remove('current');
    letterEl.classList.add('done');
    fb.textContent = `âœ“ "${targetCh}" ì •ë‹µ!`;
    fb.className   = 'feedback ok';
    playMorse(MORSE[targetCh], 1);
  } else {
    letterEl.classList.add('error');
    fb.textContent = `âœ— ì˜¤ë‹µ. "${targetCh}" = ${MORSE[targetCh]} / ì…ë ¥: ${wordState.inputMorse||'ì—†ìŒ'}`;
    fb.className   = 'feedback err';
    // still advance
  }

  wordState.letterIdx++;
  wordState.inputMorse = '';
  document.getElementById('wordMorseInput').textContent = 'â€”';

  if(wordState.letterIdx >= wordState.word.length) {
    const allDone   = document.querySelectorAll('.word-letter.done').length;
    const allLetters = wordState.word.length;
    wordState.history.push({word:wordState.word, ok:allDone, total:allLetters});
    updateWordHistory();
    fb.textContent = `ğŸ‰ ë‹¨ì–´ ì™„ì„±! "${wordState.word}" (${allDone}/${allLetters} ì •ë‹µ)`;
    fb.className   = 'feedback ok';
    document.getElementById('wordSubmitBtn').disabled = true;

    setTimeout(()=>wordStart(), 2000);
  } else {
    const next = document.getElementById(`wl-${wordState.letterIdx}`);
    if(next) next.classList.add('current');
    updateWordCurrentMorse();
  }
}

function wordShowAnswer() {
  if(!wordState.active || wordState.letterIdx >= wordState.word.length) return;
  const ch = wordState.word[wordState.letterIdx];
  const fb = document.getElementById('wordFeedback');
  fb.textContent = `ì •ë‹µ: "${ch}" = ${MORSE[ch]}`;
  fb.className   = 'feedback info';
  playMorse(MORSE[ch], 0.8);
}

function updateWordHistory() {
  const div = document.getElementById('wordHistory');
  div.innerHTML = wordState.history.slice(-5).reverse().map(h=>
    `â–¸ ${h.word}  â€”  ${h.ok}/${h.total} ì •ë‹µ`
  ).join('<br>');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHALLENGE MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let chState = {
  active: false,
  score: 0,
  correct: 0,
  streak: 0,
  timeLeft: 60,
  timerInterval: null,
  currentChar: null,
  total: 60
};

function chReset() {
  if(chState.timerInterval) clearInterval(chState.timerInterval);
  chState = {active:false, score:0, correct:0, streak:0, timeLeft:60, timerInterval:null, currentChar:null, total:60};
  document.getElementById('chReady').classList.remove('hidden');
  document.getElementById('chGame').classList.add('hidden');
}

function chStart() {
  chState.active   = true;
  chState.score    = 0;
  chState.correct  = 0;
  chState.streak   = 0;
  chState.timeLeft = 60;
  chState.total    = 60;

  document.getElementById('chReady').classList.add('hidden');
  document.getElementById('chGame').classList.remove('hidden');
  document.getElementById('chScore').textContent   = 0;
  document.getElementById('chCorrect').textContent = 0;
  document.getElementById('chTimer').textContent   = 60;
  document.getElementById('chFeedback').textContent = '';
  document.getElementById('chInput').value = '';
  document.getElementById('chInput').disabled = false;
  document.getElementById('chInput').focus();

  chState.timerInterval = setInterval(()=>{
    chState.timeLeft--;
    document.getElementById('chTimer').textContent = chState.timeLeft;
    const pct = (chState.timeLeft/chState.total)*100;
    document.getElementById('chTimerBar').style.width = pct+'%';

    if(chState.timeLeft<=0) {
      clearInterval(chState.timerInterval);
      chEnd();
    }
  }, 1000);

  chNextChar();

  // Input listener
  const inp = document.getElementById('chInput');
  inp.oninput = e=>{
    const v = e.target.value.toUpperCase().trim();
    if(v.length >= 1) chCheck(v[v.length-1]);
  };
}

function chNextChar() {
  chState.currentChar = randomChar(getCharPool());
  const container = document.getElementById('chSignals');
  const speed = getSpeed() * 1.2;
  playMorseWithVisual(MORSE[chState.currentChar], container, speed);
  document.getElementById('chInput').value = '';
}

function chPlaySignal() {
  if(!chState.currentChar) return;
  const container = document.getElementById('chSignals');
  playMorseWithVisual(MORSE[chState.currentChar], container, getSpeed()*1.2);
}

function chCheck(val) {
  if(!chState.active || !chState.currentChar) return;
  val = val.toUpperCase().trim();
  if(!val) return;

  const correct = chState.currentChar;
  const inp = document.getElementById('chInput');
  const fb  = document.getElementById('chFeedback');

  if(val === correct) {
    chState.score   += 10;
    chState.correct += 1;
    chState.streak  += 1;
    if(chState.streak >= 2) chState.score += 5; // streak bonus

    inp.className = 'answer-input correct';
    fb.textContent = chState.streak>=2
      ? `âœ“ ì—°ì† ${chState.streak}ê°œ! ë³´ë„ˆìŠ¤! (+15)` : `âœ“ ì •ë‹µ! (+10)`;
    fb.className   = 'feedback ok';
    totalScore += 10;
  } else {
    chState.score  = Math.max(0, chState.score - 5);
    chState.streak = 0;
    inp.className  = 'answer-input wrong';
    fb.textContent = `âœ— ì˜¤ë‹µ. ì •ë‹µ: "${correct}"  (-5)`;
    fb.className   = 'feedback err';
    totalStreak = 0;
  }

  document.getElementById('chScore').textContent   = chState.score;
  document.getElementById('chCorrect').textContent = chState.correct;
  updateHeaderStats();

  setTimeout(()=>{
    inp.className = 'answer-input';
    if(chState.active) chNextChar();
  }, 600);
}

function chEnd() {
  chState.active = false;
  document.getElementById('chInput').disabled = true;

  // Show result
  const overlay = document.getElementById('resultOverlay');
  document.getElementById('resultTitle').textContent = 'ì±Œë¦°ì§€ ì¢…ë£Œ!';
  document.getElementById('resultScore').textContent  = chState.score;
  document.getElementById('resultSub').innerHTML =
    `ì •ë‹µ ${chState.correct}ê°œ &nbsp;|&nbsp; ìµœì¢… ì ìˆ˜ ${chState.score}ì <br>` +
    (chState.score>=200 ? 'ğŸ† ë†€ë¼ìš´ ì„±ê³¼! MORSE MASTER!' :
     chState.score>=100 ? 'â­ í›Œë¥­í•©ë‹ˆë‹¤! ê³„ì† ì—°ìŠµí•˜ì„¸ìš”!' :
     'ğŸ“¡ ê³„ì† ë„ì „í•˜ì„¸ìš”!');
  overlay.classList.add('show');

  totalScore += chState.score;
  updateHeaderStats();
}

function closeResult() {
  document.getElementById('resultOverlay').classList.remove('show');
  chReset();
}

// Build study table on load
window.addEventListener('load', ()=>{
  buildRefTable();
  showScreen('home');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCENARIO MODE â€” AI MORSE COMMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Scenario definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ Random intel generator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateMissionIntel() {
  const grids    = ['ALPHA 4','BRAVO 7','CHARLIE 2','DELTA 9','ECHO 5','FOXTROT 3','GOLF 8','HOTEL 1'];
  const gridsKo  = ['ì•ŒíŒŒ 4êµ¬ì—­','ë¸Œë¼ë³´ 7êµ¬ì—­','ì°°ë¦¬ 2êµ¬ì—­','ë¸íƒ€ 9êµ¬ì—­','ì—ì½” 5êµ¬ì—­','í­ìŠ¤íŠ¸ë¡¯ 3êµ¬ì—­','ê³¨í”„ 8êµ¬ì—­','í˜¸í…” 1êµ¬ì—­'];

  const trenchStates    = ['heavily fortified with machine gun nests','lightly defended, roughly 20 troops','abandoned but booby-trapped','reinforced with barbed wire and AT guns','occupied by approximately 50 infantry'];
  const trenchStatesKo  = ['ê¸°ê´€ì´ ì§„ì§€ë¡œ ì¤‘ë¬´ì¥','ì•½ 20ëª… ê²½ë¹„, ë°©ì–´ ì·¨ì•½','ë°©ì¹˜ëìœ¼ë‚˜ ë¶€ë¹„íŠ¸ë© ì„¤ì¹˜','ì² ì¡°ë§ + ëŒ€ì „ì°¨í¬ ë³´ê°•','ë³´ë³‘ ì•½ 50ëª… ì£¼ë‘” ì¤‘'];

  const supplies    = ['critical â€” less than 2 days remaining','sufficient for 5 days','low on ammunition, food adequate','medical supplies depleted','fuel reserves at 30 percent'];
  const suppliesKo  = ['ìœ„ê¸° â€” ì´í‹€ì¹˜ ì”ì—¬','5ì¼ì¹˜ ì¶©ë¶„','íƒ„ì•½ ë¶€ì¡±, ì‹ëŸ‰ ì–‘í˜¸','ì˜ì•½í’ˆ ê³ ê°ˆ','ì—°ë£Œ 30% ì”ì—¬'];

  const readiness   = ['cannot sustain beyond 48 hours','able to hold for 3 days','need immediate resupply to continue','combat effective but stretched thin','requesting withdrawal authorization'];
  const readinessKo = ['48ì‹œê°„ ì´ìƒ ì§€ì† ë¶ˆê°€','3ì¼ ë²„í‹¸ ìˆ˜ ìˆìŒ','ì¦‰ì‹œ ë³´ê¸‰ í•„ìš”','ì „íˆ¬ ê°€ëŠ¥í•˜ë‚˜ í•œê³„ ë„ë‹¬','ì² ìˆ˜ í—ˆê°€ ìš”ì²­ í•„ìš”'];

  const survivors   = [12,18,24,7,31,15];
  const survivorsKo = ['12ëª…','18ëª…','24ëª…','7ëª…','31ëª…','15ëª…'];

  const coords   = ['34N 12E','41N 08E','29N 17E','38N 05E','44N 21E'];
  const coordsKo = ['ë¶ìœ„ 34ë„ ë™ê²½ 12ë„','ë¶ìœ„ 41ë„ ë™ê²½ 08ë„','ë¶ìœ„ 29ë„ ë™ê²½ 17ë„','ë¶ìœ„ 38ë„ ë™ê²½ 05ë„','ë¶ìœ„ 44ë„ ë™ê²½ 21ë„'];

  const targets    = ['armored column 8 vehicles','infantry company 80 men','supply depot large structure','mortar battery 4 guns','command post fortified'];
  const targetsKo  = ['ê¸°ê°‘ ì¢…ëŒ€ ì°¨ëŸ‰ 8ëŒ€','ë³´ë³‘ ì¤‘ëŒ€ ì•½ 80ëª…','ëŒ€í˜• ë³´ê¸‰ ì°½ê³ ','ë°•ê²©í¬ í¬ëŒ€ 4ë¬¸','ìš”ìƒˆí™”ëœ ì§€íœ˜ì†Œ'];

  const locations    = ['warehouse district sector 7','railway junction north of town','farmhouse 3km past river','church tower overlooking square','underground bunker east road'];
  const locationsKo  = ['ì°½ê³  ì§€êµ¬ ì„¹í„° 7','ë§ˆì„ ë¶ìª½ ì² ë„ êµì°¨ì ','ê°• ê±´ë„ˆ 3km ë†ê°€','ê´‘ì¥ ë‚´ë ¤ë‹¤ë³´ëŠ” êµíšŒ íƒ‘','ë™ìª½ ë„ë¡œ ì§€í•˜ ë²™ì»¤'];

  const risk    = ['exposure risk high, patrol nearby','secure for now, 10 minutes','compromised, need extraction now','minimal risk, all clear'];
  const riskKo  = ['ìœ„í—˜ â€” ì  ìˆœì°°ëŒ€ ê·¼ì ‘','í˜„ì¬ ì•ˆì „, 10ë¶„ ì—¬ìœ ','ë…¸ì¶œë¨, ì¦‰ì‹œ íƒˆì¶œ í•„ìš”','ìœ„í—˜ ì—†ìŒ, ì´ìƒ ì—†ìŒ'];

  const exits    = ['Route BRAVO via river crossing','Route DELTA through forest','Route ALPHA northeast checkpoint','submarine rendezvous at cove'];
  const exitsKo  = ['ë£¨íŠ¸ BRAVO â€” ê°• ë„í•˜','ë£¨íŠ¸ DELTA â€” ìˆ² í†µê³¼','ë£¨íŠ¸ ALPHA â€” ë¶ë™ ì²´í¬í¬ì¸íŠ¸','í›„ë¯¸ í•´ì•ˆ ì ìˆ˜í•¨ ë‘ë°ë¶€'];

  const pick = (arr, ko) => {
    const i = Math.floor(Math.random() * arr.length);
    return { en: arr[i], ko: ko[i] };
  };

  const g = pick(grids, gridsKo);
  const tr = pick(trenchStates, trenchStatesKo);
  const su = pick(supplies, suppliesKo);
  const re = pick(readiness, readinessKo);
  const sv = pick(survivors, survivorsKo);
  const co = pick(coords, coordsKo);
  const tg = pick(targets, targetsKo);
  const lo = pick(locations, locationsKo);
  const ri = pick(risk, riskKo);
  const ex = pick(exits, exitsKo);

  return {
    grid: g.en,       gridKo: g.ko,
    trenchState: tr.en, trenchStateKo: tr.ko,
    supplyStatus: su.en, supplyStatusKo: su.ko,
    combatReadiness: re.en, combatReadinessKo: re.ko,
    survivorCount: sv.en, survivorCountKo: sv.ko,
    coord: co.en,     coordKo: co.ko,
    target: tg.en,    targetKo: tg.ko,
    location: lo.en,  locationKo: lo.ko,
    exposureRisk: ri.en, exposureRiskKo: ri.ko,
    exitRoute: ex.en,    exitRouteKo: ex.ko
  };
}

const SCENARIOS = [
  {
    id: 'recon',
    icon: 'ğŸ”­',
    title: 'ì „ë°© ì •ì°° ë³´ê³ ',
    callsign: 'OVERLORD',
    desc: 'ì „ë°© ì°¸í˜¸ë¥¼ ì •ì°°í•˜ê³  ëŒì•„ì˜¨ ë‹¹ì‹ . ì‚¬ë ¹ë¶€ OVERLORDì—ê²Œ ì„¸ ê°€ì§€ë¥¼ ë³´ê³ í•´ì•¼ í•©ë‹ˆë‹¤.',
    objectives: [
      'ì  ì°¸í˜¸ ê´€ì°° ê²°ê³¼ ë³´ê³ ',
      'ì•„êµ° ë³´ê¸‰ í˜„í™© ë³´ê³ ',
      'ì•„êµ° ì „íˆ¬ ì§€ì† ê°€ëŠ¥ ì—¬ë¶€ ì „ë‹¬'
    ],
    buildPrompt: (intel) => `You are OVERLORD, a commanding officer. Radio comms, WWII 1944 Western Front.
YOUR SCOUT (the player) just returned from enemy recon. You need 3 reports FROM THE PLAYER about OUR OWN SIDE:
1) What the player OBSERVED at the ENEMY trench (location: grid ${intel.grid})
2) OUR OWN supply status (actual status: ${intel.supplyStatus})
3) OUR OWN combat readiness / can we keep fighting (actual: ${intel.combatReadiness})

CRITICAL RULES:
- You are asking the PLAYER (scout) to report to YOU. Do NOT ask about enemy supplies or enemy readiness.
- The player must volunteer the intel. You ask for it one item at a time.
- Max 10 words per response. Military brevity. No pleasantries.
- English only (morse code).
- Start: identify the player's callsign, then ask for their trench observation report.
- When all 3 received, say exactly: "ROGER. MISSION COMPLETE. RETURN TO BASE. OUT"
- Response format: plain radio text only, no labels, no quotes.`
  },
  {
    id: 'rescue',
    icon: 'ğŸš‘',
    title: 'ì¡°ë‚œ êµ¬ì¡° ìš”ì²­',
    callsign: 'SEA-WOLF',
    desc: 'êµ¬ì¶•í•¨ì´ í”¼ê²©ë‹¹í•´ ì¹¨ëª° ì¤‘ì…ë‹ˆë‹¤. í•´ì•ˆê¸°ì§€ì— ì„¸ ê°€ì§€ ì •ë³´ë¥¼ ì „ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤.',
    objectives: [
      'í•¨ì„  ìœ„ì¹˜ ì¢Œí‘œ ì „ë‹¬',
      'ìƒì¡´ì/ë¶€ìƒì í˜„í™© ë³´ê³ ',
      'ê¸´ê¸‰ êµ¬ì¡° ìš”ì²­ í™•ì¸'
    ],
    buildPrompt: (intel) => `You are SEA-WOLF, coastal rescue operator. WWII 1943 Pacific.
A damaged destroyer is calling. You need from the player:
1) Ship position (actual: coordinates ${intel.coord})
2) Survivor count and casualties (actual: ${intel.survivorCount} survivors)
3) Urgency confirmation and rescue request

CRITICAL RULES:
- Max 10 words per message. Naval brevity codes.
- English only.
- Acknowledge each item received before asking next.
- When all 3 received: "RESCUE DISPATCHED. HOLD POSITION. MISSION COMPLETE. OUT"
- Response format: plain radio text only.`
  },
  {
    id: 'artillery',
    icon: 'ğŸ’£',
    title: 'í¬ê²© ì¢Œí‘œ ìœ ë„',
    callsign: 'THUNDER-1',
    desc: 'ì „ë°© ê´€ì¸¡ë³‘ìœ¼ë¡œì„œ í¬ë³‘ëŒ€ì— ì„¸ ê°€ì§€ ì •ë³´ë¥¼ ì „ë‹¬í•´ì•¼ í•©ë‹ˆë‹¤.',
    objectives: [
      'ëª©í‘œ ì¢Œí‘œ ì „ë‹¬',
      'ëª©í‘œë¬¼ íŠ¹ì„± ë³´ê³ ',
      'ì‚¬ê²© ê²°ê³¼ ê´€ì¸¡ ë° ìˆ˜ì •'
    ],
    buildPrompt: (intel) => `You are THUNDER-1, artillery battery commander. WWII 1944 Normandy.
Forward observer (player) must give you:
1) Target grid coordinates (actual: ${intel.grid})
2) Target description (actual: ${intel.target})
3) Fire adjustment after first salvo

CRITICAL RULES:
- Max 10 words. Artillery procedure brevity.
- English only.
- Use "SHOT, OVER" and "SPLASH, OVER" procedure naturally.
- When all 3 received and adjusted: "FIRE MISSION COMPLETE. OUT"
- Response format: plain radio text only.`
  },
  {
    id: 'spy',
    icon: 'ğŸ•µï¸',
    title: 'ì ì§„ ì¹¨íˆ¬ ë³´ê³ ',
    callsign: 'NIGHTSHADE',
    desc: 'ì ì§€ì— ì¹¨íˆ¬í•œ ì²©ë³´ì›ì…ë‹ˆë‹¤. ëŸ°ë˜ ë³¸ë¶€ì— ì„¸ ê°€ì§€ë¥¼ íƒ€ì „í•´ì•¼ í•©ë‹ˆë‹¤.',
    objectives: [
      'ëª©í‘œë¬¼ ìœ„ì¹˜ í™•ì¸ ë³´ê³ ',
      'ë…¸ì¶œ ìœ„í—˜ë„ ë° ì‘ì „ ìƒí™©',
      'íƒˆì¶œ ë£¨íŠ¸ ë° í”½ì—… ì§€ì '
    ],
    buildPrompt: (intel) => `You are NIGHTSHADE, SOE London handler. WWII 1943.
Field agent (player) must transmit:
1) Target location confirmed (actual: ${intel.location})
2) Exposure risk and operational status (actual: ${intel.exposureRisk})
3) Exfiltration route and pickup point (actual: ${intel.exitRoute})

CRITICAL RULES:
- Max 10 words. Spy radio terse codes.
- English only. Transmission security is critical.
- Acknowledge each item, then ask for next.
- Remind brevity once if player is too verbose.
- When all 3 received: "UNDERSTOOD. EXTRACTION ARRANGED. GO DARK. MISSION COMPLETE."
- Response format: plain radio text only.`
  }
];

// â”€â”€ ì‹œë‚˜ë¦¬ì˜¤ë³„ Intel Panel ì •ì˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SCENARIOS[0].buildIntelPanel = (intel) => [
  { label: 'ì  ì°¸í˜¸ ìœ„ì¹˜',   value: intel.gridKo,            en: intel.grid,            hint: 'ì´ ê·¸ë¦¬ë“œ ìœ„ì¹˜ë¥¼ ë³´ê³ í•˜ì„¸ìš”' },
  { label: 'ì  ì°¸í˜¸ ìƒíƒœ',   value: intel.trenchStateKo,     en: intel.trenchState,     hint: 'ê´€ì°°í•œ ì  ì°¸í˜¸ ìƒíƒœë¥¼ ì„¤ëª…í•˜ì„¸ìš”' },
  { label: 'ì•„êµ° ë³´ê¸‰ í˜„í™©', value: intel.supplyStatusKo,    en: intel.supplyStatus,    hint: 'ìš°ë¦¬ ë³´ê¸‰ ìƒíƒœë¥¼ ë³´ê³ í•˜ì„¸ìš”' },
  { label: 'ì „íˆ¬ ì§€ì† ê°€ëŠ¥', value: intel.combatReadinessKo, en: intel.combatReadiness, hint: 'ìš°ë¦¬ ì „íˆ¬ ì§€ì† ê°€ëŠ¥ ì—¬ë¶€ë¥¼ ë³´ê³ í•˜ì„¸ìš”' }
];
SCENARIOS[1].buildIntelPanel = (intel) => [
  { label: 'í•¨ì„  ì¢Œí‘œ',  value: intel.coordKo,                          en: intel.coord,                          hint: 'ì´ ì¢Œí‘œë¥¼ íƒ€ì „í•˜ì„¸ìš”' },
  { label: 'ìƒì¡´ì ìˆ˜',  value: intel.survivorCountKo + ' ìƒì¡´',         en: intel.survivorCount + ' survivors',    hint: 'ìƒì¡´ì ìˆ˜ë¥¼ ë³´ê³ í•˜ì„¸ìš”' },
  { label: 'êµ¬ì¡° ìš”ì²­',  value: 'ì¹¨ëª° ìœ„ê¸° â€” ì¦‰ê° êµ¬ì¡° í•„ìš”',             en: 'sinking, immediate rescue needed',    hint: 'ê¸´ê¸‰ êµ¬ì¡°ë¥¼ ìš”ì²­í•˜ì„¸ìš”' }
];
SCENARIOS[2].buildIntelPanel = (intel) => [
  { label: 'ëª©í‘œ ê·¸ë¦¬ë“œ', value: intel.gridKo,    en: intel.grid,    hint: 'ì´ ì¢Œí‘œë¥¼ í¬ë³‘ëŒ€ì— ì „ë‹¬í•˜ì„¸ìš”' },
  { label: 'ëª©í‘œë¬¼ ì¢…ë¥˜', value: intel.targetKo,  en: intel.target,  hint: 'ëª©í‘œë¬¼ íŠ¹ì„±ì„ ì„¤ëª…í•˜ì„¸ìš”' },
  { label: 'ì‚¬ê²© ìˆ˜ì •',   value: 'ì²« í¬ê²© í›„ íƒ„ì°© ê´€ì¸¡ â†’ ìˆ˜ì • ì§€ì‹œ', en: 'report adjustment after first salvo', hint: 'íƒ„ì°©ì  ë³´ê³  í›„ ìˆ˜ì • ëª…ë ¹í•˜ì„¸ìš”' }
];
SCENARIOS[3].buildIntelPanel = (intel) => [
  { label: 'ëª©í‘œë¬¼ ìœ„ì¹˜', value: intel.locationKo,    en: intel.location,    hint: 'ëª©í‘œ ìœ„ì¹˜ë¥¼ ë³´ê³ í•˜ì„¸ìš”' },
  { label: 'ë…¸ì¶œ ìœ„í—˜ë„', value: intel.exposureRiskKo, en: intel.exposureRisk, hint: 'í˜„ì¬ ìƒí™©ì„ ë³´ê³ í•˜ì„¸ìš”' },
  { label: 'íƒˆì¶œ ë£¨íŠ¸',   value: intel.exitRouteKo,   en: intel.exitRoute,   hint: 'íƒˆì¶œ ê²½ë¡œë¥¼ ì „ë‹¬í•˜ì„¸ìš”' }
];
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let scState = {
  apiKey: '',
  selectedScenario: null,
  selectedIdx: -1,
  phase: 'apikey',
  conversationHistory: [],
  currentMorse: '',
  keyDown: false,
  keyDownTime: null,
  dotThreshold: 200,
  wordTimerHandle: null,
  wordTimerDelay: 400,
  completedChars: [],
  completedWords: [],
  lastAiMorse: '',
  lastAiText: '',
  missionProgress: 0,
  missionDone: false,
  waiting: false,
  diagnosedModel: null,
  currentIntel: null,       // ì´ë²ˆ íšŒì°¨ ëœë¤ intel
  customScenarios: [],      // í”Œë ˆì´ì–´ê°€ ë§Œë“  ì‹œë‚˜ë¦¬ì˜¤
  objChecked: []            // ëª©í‘œ ì²´í¬ ìƒíƒœ ì¶”ì 
};

// â”€â”€ Navigation init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scInit() {
  if (scState.apiKey) {
    showScStep('select');
    buildScenarioCards();
  } else {
    showScStep('apikey');
  }
}

function showScStep(step) {
  ['apikey','select','comms','creator'].forEach(s => {
    const el = document.getElementById('sc-step-' + s);
    if (el) el.classList.add('hidden');
  });
  const target = document.getElementById('sc-step-' + step);
  if (target) target.classList.remove('hidden');
  scState.phase = step;
}

// â”€â”€ API Key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scSaveApiKey() {
  const key = document.getElementById('scApiKey').value.trim();
  if (!key || !key.startsWith('AI')) {
    alert('ìœ íš¨í•œ API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš” (AIza... í˜•ì‹)');
    return;
  }
  scState.apiKey = key;
  showScStep('select');
  buildScenarioCards();
}

function scChangeApiKey() {
  scState.apiKey = '';
  document.getElementById('scApiKey').value = '';
  showScStep('apikey');
}

function showScenarioCreator() {
  showScStep('creator');
  document.getElementById('scCreatorInput').value = '';
  document.getElementById('scCreatorStatus').textContent = '';
}

function scCancelCreator() {
  showScStep('select');
}

async function scCreateScenario() {
  const userDesc = document.getElementById('scCreatorInput').value.trim();
  if (!userDesc) { alert('ìƒí™©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”'); return; }

  const statusEl = document.getElementById('scCreatorStatus');
  const btn = document.getElementById('scCreateBtn');
  statusEl.textContent = 'AIê°€ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...';
  btn.disabled = true;

  const creatorPrompt = `You are a game designer creating a military/naval WWII-era radio communication scenario for a Morse code training game.

The user described this situation in Korean: "${userDesc}"

Create a scenario with this EXACT JSON format. Output raw JSON only â€” no markdown, no backticks, no explanation:
{
  "icon": "<one emoji fitting the scenario>",
  "titleKo": "<ì‹œë‚˜ë¦¬ì˜¤ ì œëª©, í•œêµ­ì–´ 10ì ì´ë‚´>",
  "descKo": "<ìƒí™© ì„¤ëª…, í•œêµ­ì–´ 60ì ì´ë‚´>",
  "callsign": "<radio callsign 1-2 English words>",
  "objectivesKo": ["<ëª©í‘œ1 í•œêµ­ì–´>", "<ëª©í‘œ2 í•œêµ­ì–´>", "<ëª©í‘œ3 í•œêµ­ì–´>"],
  "intelItems": [
    {
      "labelKo": "<ì •ë³´ í•­ëª© ì´ë¦„, í•œêµ­ì–´ 8ì ì´ë‚´>",
      "valueKo": "<í”Œë ˆì´ì–´ê°€ ì „ë‹¬í•´ì•¼ í•  êµ¬ì²´ì  ì •ë³´ê°’, í•œêµ­ì–´. ì˜ˆ: ë¶ìœ„ 37ë„ ë™ê²½ 126ë„, ìƒì¡´ì 14ëª…, ì—°ë£Œ 20% ë“±>",
      "valueEn": "<same info in English, for morse transmission. Short: e.g. 37N 126E, 14 survivors, fuel 20 percent>",
      "hintKo": "<ì´ ì •ë³´ë¥¼ ì–´ë–»ê²Œ ë³´ë‚´ì•¼ í•˜ëŠ”ì§€ íŒíŠ¸, í•œêµ­ì–´>"
    },
    { "labelKo": "...", "valueKo": "...", "valueEn": "...", "hintKo": "..." },
    { "labelKo": "...", "valueKo": "...", "valueEn": "...", "hintKo": "..." }
  ],
  "systemPromptEn": "You are [callsign], [role]. [Setting]. Player must report 3 items: 1) [item1 description, mention actual value: VALUEPLACEHOLDER_1], 2) [item2], 3) [item3]. RULES: max 10 words per message. English only. Ask one item at a time. When all 3 received say: MISSION COMPLETE OUT"
}

Important: intelItems must have exactly 3 items matching the 3 objectives. The valueEn must be short enough to transmit in morse (under 6 words).`;

  try {
    const MODELS = ['gemini-1.5-flash','gemini-1.5-flash-latest','gemini-1.5-flash-001','gemini-1.0-pro','gemini-pro'];
    const tryModels = scState.diagnosedModel
      ? [scState.diagnosedModel, ...MODELS] : MODELS;

    let res = null;
    for (const m of tryModels) {
      res = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/${m}:generateContent?key=${scState.apiKey}`,
        {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({
            contents: [{ role:'user', parts:[{ text: creatorPrompt }] }]
          })
        }
      );
      if (res.ok) { scState.diagnosedModel = m; break; }
      res = null;
    }
    if (!res) throw new Error('ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ì—†ìŒ');

    const data = await res.json();
    let raw = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || '';
    // JSON íŒŒì‹±
    raw = raw.replace(/```json/g,'').replace(/```/g,'').trim();
    const sc = JSON.parse(raw);

    // intelItemsë¥¼ buildIntelPanel í•¨ìˆ˜ë¡œ ë³€í™˜
    const intelItems = sc.intelItems || [];
    const intelPanelFn = intelItems.length > 0
      ? (_intel) => intelItems.map(item => ({
          label: item.labelKo,
          value: item.valueKo,
          en:    item.valueEn,
          hint:  item.hintKo
        }))
      : null;

    // systemPromptì—ì„œ VALUEPLACEHOLDERë¥¼ ì‹¤ì œ ê°’ìœ¼ë¡œ ì¹˜í™˜
    let finalPrompt = sc.systemPromptEn || '';
    intelItems.forEach((item, i) => {
      finalPrompt = finalPrompt.replace('VALUEPLACEHOLDER_' + (i+1), item.valueEn);
    });

    // ì»¤ìŠ¤í…€ ì‹œë‚˜ë¦¬ì˜¤ ê°ì²´ë¡œ ë³€í™˜
    const newScenario = {
      id: 'custom_' + Date.now(),
      icon: sc.icon || 'ğŸ–ï¸',
      title: sc.titleKo,
      callsign: sc.callsign,
      desc: sc.descKo,
      objectives: sc.objectivesKo,
      buildPrompt: (_intel) => finalPrompt,
      buildIntelPanel: intelPanelFn
    };

    scState.customScenarios.push(newScenario);
    statusEl.textContent = 'âœ“ ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± ì™„ë£Œ!';

    setTimeout(() => {
      showScStep('select');
      buildScenarioCards();
      // ë°©ê¸ˆ ë§Œë“  ì¹´ë“œ ìë™ ì„ íƒ
      const idx = SCENARIOS.length + scState.customScenarios.length - 1;
      selectScenario(idx);
    }, 800);

  } catch(e) {
    statusEl.textContent = 'âš  ì˜¤ë¥˜: ' + e.message;
    btn.disabled = false;
  }
}

async function scDiagnoseKey() {
  const key = document.getElementById('scApiKey').value.trim();
  if (!key) { alert('ë¨¼ì € API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
  const diagEl = document.getElementById('scDiagResult');
  diagEl.textContent = 'ì¡°íšŒ ì¤‘...';

  try {
    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models?key=${key}`
    );
    if (!res.ok) {
      const err = await res.json();
      diagEl.textContent = 'ì˜¤ë¥˜: ' + (err.error?.message || res.status);
      return;
    }
    const data = await res.json();
    const models = (data.models || [])
      .filter(m => m.supportedGenerationMethods?.includes('generateContent'))
      .map(m => m.name.replace('models/', ''));

    if (models.length === 0) {
      diagEl.textContent = 'âš  generateContent ì§€ì› ëª¨ë¸ ì—†ìŒ\nê²°ì œ ì„¤ì • ë˜ëŠ” API í™œì„±í™” í•„ìš”';
    } else {
      diagEl.innerHTML = 'âœ“ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸:<br>' + models.map(m => '  Â· ' + m).join('<br>');
      // ì²« ë²ˆì§¸ flash ëª¨ë¸ ìë™ ì„ íƒ
      const flashModel = models.find(m => m.includes('flash')) || models[0];
      scState.diagnosedModel = flashModel;
      diagEl.innerHTML += '<br><br>â–¸ ìë™ ì„ íƒ: <strong style="color:var(--green)">' + flashModel + '</strong>';
    }
  } catch(e) {
    diagEl.textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + e.message;
  }
}

// â”€â”€ Scenario select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildScenarioCards() {
  const container = document.getElementById('scCards');
  container.innerHTML = '';

  // ê¸°ë³¸ ì‹œë‚˜ë¦¬ì˜¤
  const allScenarios = [...SCENARIOS, ...scState.customScenarios];
  allScenarios.forEach((sc, i) => {
    const card = document.createElement('div');
    card.className = 'scenario-card';
    card.id = 'sc-card-' + i;
    card.innerHTML = `
      <div class="sc-icon">${sc.icon}</div>
      <div class="sc-title">${sc.title}</div>
      <div class="sc-desc">${sc.desc}</div>
      <div class="sc-obj">ëª©í‘œ: ${sc.objectives.join(' / ')}</div>
    `;
    card.onclick = () => selectScenario(i);
    container.appendChild(card);
  });

  // ì»¤ìŠ¤í…€ ì‹œë‚˜ë¦¬ì˜¤ ë§Œë“¤ê¸° ì¹´ë“œ
  const addCard = document.createElement('div');
  addCard.className = 'scenario-card';
  addCard.style.borderStyle = 'dashed';
  addCard.innerHTML = `
    <div class="sc-icon">âœï¸</div>
    <div class="sc-title">ë‚˜ë§Œì˜ ì‹œë‚˜ë¦¬ì˜¤ ë§Œë“¤ê¸°</div>
    <div class="sc-desc">ìƒí™©ì„ ììœ ë¡­ê²Œ ì…ë ¥í•˜ë©´ AIê°€ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ìƒì„±í•´ì¤ë‹ˆë‹¤</div>
    <div class="sc-obj">í•œêµ­ì–´ë¡œ ìƒí™©ì„ ì…ë ¥í•˜ì„¸ìš”</div>
  `;
  addCard.onclick = () => showScenarioCreator();
  container.appendChild(addCard);
}

function selectScenario(idx) {
  document.querySelectorAll('.scenario-card').forEach(c => c.classList.remove('selected'));
  document.getElementById('sc-card-' + idx).classList.add('selected');
  scState.selectedIdx = idx;
  const allScenarios = [...SCENARIOS, ...scState.customScenarios];
  scState.selectedScenario = allScenarios[idx];
  document.getElementById('scStartBtn').disabled = false;
}

// â”€â”€ Mission begin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function scBeginMission() {
  const sc = scState.selectedScenario;
  if (!sc) return;

  // ì´ë²ˆ íšŒì°¨ ëœë¤ intel ìƒì„±
  scState.currentIntel = generateMissionIntel();
  scState.objChecked = new Array(sc.objectives.length).fill(false);

  // Reset state
  scState.conversationHistory = [];
  scState.completedChars = [];
  scState.completedWords = [];
  scState.currentMorse = '';
  scState.missionProgress = 0;
  scState.missionDone = false;
  scState.waiting = false;
  scState.lastAiMorse = '';
  scState.lastAiText = '';

  // UI setup
  document.getElementById('scCallsign').textContent = sc.callsign;
  document.getElementById('scMissionTitle').textContent = sc.title.toUpperCase();
  buildObjectives();
  setProgress(0);
  clearMsgLog();
  scAddMsg('system', null, 'ì•”í˜¸ í†µì‹  ê°œì‹œ. êµì‹  ëŒ€ê¸° ì¤‘...');
  clearTxUI();
  intelPanelOpen = true;
  renderIntelPanel();
  document.getElementById('scSendBtn').disabled = true;

  showScStep('comms');

  // First AI message
  scSetStatus('ìˆ˜ì‹  ì¤‘', 'amber');
  await scGetAiResponse(null);
}

function scBeginMissionAgain() {
  closeMissionOverlay();
  if (scState.selectedScenario) {
    showScStep('select');
    setTimeout(() => scBeginMission(), 100);
  }
}

// â”€â”€ Objectives UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildObjectives() {
  const sc = scState.selectedScenario;
  scState.objChecked = new Array(sc.objectives.length).fill(false);
  const el = document.getElementById('scObjectives');
  el.innerHTML = '<div style="font-size:0.65rem;letter-spacing:0.15em;margin-bottom:6px;color:rgba(255,179,0,0.6);">â–¸ ì„ë¬´ ëª©í‘œ</div>' +
    sc.objectives.map((obj, i) =>
      `<div class="obj-item" id="obj-${i}">
        <span class="obj-pending" id="obj-icon-${i}" style="color:var(--text-dim)">â—‹</span>
        <span id="obj-text-${i}" style="color:var(--text-dim)">${obj}</span>
      </div>`
    ).join('');
}

function renderIntelPanel() {
  const sc     = scState.selectedScenario;
  const intel  = scState.currentIntel;
  const panel  = document.getElementById('scIntelPanel');
  const rows   = document.getElementById('scIntelRows');

  if (!sc || !intel || !sc.buildIntelPanel) {
    panel.style.display = 'none';
    return;
  }

  const items = sc.buildIntelPanel(intel);
  panel.style.display = 'block';
  rows.innerHTML = items.map(item => `
    <div class="intel-row">
      <span class="intel-label">${item.label}</span>
      <span class="intel-value">${item.value}
        <span class="intel-en">(${item.en})</span>
      </span>
      <span class="intel-hint">${item.hint}</span>
    </div>
  `).join('');
}

let intelPanelOpen = true;
function toggleIntelPanel() {
  const rows = document.getElementById('scIntelRows');
  const icon = document.getElementById('scIntelToggleIcon');
  intelPanelOpen = !intelPanelOpen;
  rows.style.display = intelPanelOpen ? 'block' : 'none';
  icon.textContent   = intelPanelOpen ? 'â–¾' : 'â–¸';
}

function completeObjective(idx) {
  if (scState.objChecked[idx]) return;  // ì´ë¯¸ ì²´í¬ëìœ¼ë©´ ë¬´ì‹œ
  scState.objChecked[idx] = true;
  const icon = document.getElementById('obj-icon-' + idx);
  const text = document.getElementById('obj-text-' + idx);
  if (icon) {
    icon.className = 'obj-check';
    icon.textContent = 'âœ“';
    icon.style.color = 'var(--green)';
  }
  if (text) text.style.color = 'var(--green)';
}

function setProgress(pct) {
  scState.missionProgress = pct;
  document.getElementById('scProgressBar').style.width = pct + '%';
  document.getElementById('scProgressPct').textContent = pct + '%';
}

// â”€â”€ Status dot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scSetStatus(text, color) {
  document.getElementById('scStatusText').textContent = text;
  const dot = document.getElementById('scStatusDot');
  dot.className = 'status-dot' + (color ? ' ' + color : '');
}

// â”€â”€ Message log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function clearMsgLog() {
  document.getElementById('scMsgLog').innerHTML = '';
}

function scAddMsg(type, morseStr, text) {
  const log = document.getElementById('scMsgLog');
  const entry = document.createElement('div');
  entry.className = 'msg-entry ' + type;

  let metaText = '';
  if (type === 'incoming') metaText = 'â–¸ ìˆ˜ì‹  â€” ' + (scState.selectedScenario?.callsign || 'COMMAND');
  if (type === 'outgoing') metaText = 'â–¸ ì†¡ì‹  â€” YOU';
  if (type === 'system')   metaText = 'SYSTEM';

  entry.innerHTML = `
    <div class="msg-meta">${metaText}</div>
    <div>${text}</div>
    ${morseStr ? `<div class="msg-morse">${morseStr}</div>` : ''}
  `;
  log.appendChild(entry);
  log.scrollTop = log.scrollHeight;
}

// â”€â”€ Gemini API call â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function scGetAiResponse(playerMessage) {
  scState.waiting = true;
  scSetStatus('êµì‹  ì¤‘', 'amber');
  document.getElementById('scSendBtn').disabled = true;
  document.getElementById('scRcvStatus').innerHTML = '<span class="rcv-waiting thinking-dots">ìˆ˜ì‹  ëŒ€ê¸° ì¤‘</span>';

  // Build messages
  if (playerMessage) {
    scState.conversationHistory.push({
      role: 'user',
      parts: [{ text: playerMessage }]
    });
  }

  // system promptë¥¼ ì²« ë²ˆì§¸ user ë©”ì‹œì§€ë¡œ ì£¼ì…
  // ì‹œë‚˜ë¦¬ì˜¤ì— ë”°ë¼ systemPrompt ë˜ëŠ” buildPrompt(intel) ì‚¬ìš©
  const sc = scState.selectedScenario;
  const promptText = sc.buildPrompt
    ? sc.buildPrompt(scState.currentIntel || generateMissionIntel())
    : sc.systemPrompt;
  const systemMsg = {
    role: 'user',
    parts: [{ text: promptText }]
  };
  const systemAck = {
    role: 'model',
    parts: [{ text: 'Understood. Ready to begin transmission.' }]
  };

  let contents;
  if (scState.conversationHistory.length > 0) {
    contents = [systemMsg, systemAck, ...scState.conversationHistory];
  } else {
    contents = [
      systemMsg,
      systemAck,
      { role: 'user', parts: [{ text: '[BEGIN TRANSMISSION - Make first contact]' }] }
    ];
  }

  const payload = { contents };

  try {
    // ì§„ë‹¨ëœ ëª¨ë¸ ìš°ì„ , ì—†ìœ¼ë©´ ìˆœì„œëŒ€ë¡œ ì‹œë„
    const MODELS_TO_TRY = scState.diagnosedModel
      ? [scState.diagnosedModel, 'gemini-1.5-flash', 'gemini-1.5-flash-latest', 'gemini-1.5-flash-001', 'gemini-1.0-pro', 'gemini-pro']
      : ['gemini-1.5-flash', 'gemini-1.5-flash-latest', 'gemini-1.5-flash-001', 'gemini-1.0-pro', 'gemini-pro'];

    let res = null;
    let lastErr = '';
    for (const modelName of MODELS_TO_TRY) {
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${scState.apiKey}`;
      try {
        res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (res.ok) {
          console.log('ì‚¬ìš© ëª¨ë¸:', modelName);
          scState.activeModel = modelName;
          break;
        }
        const errBody = await res.clone().json();
        lastErr = errBody.error?.message || res.status;
        // 404(not found)ë©´ ë‹¤ìŒ ëª¨ë¸ ì‹œë„, ë‹¤ë¥¸ ì˜¤ë¥˜ë©´ ì¤‘ë‹¨
        if (!lastErr.includes('not found') && !lastErr.includes('not supported')) break;
        res = null;
      } catch(fetchErr) {
        lastErr = fetchErr.message;
      }
    }
    if (!res) throw new Error('ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë¸ ì—†ìŒ: ' + lastErr);

    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error?.message || 'API ì˜¤ë¥˜ ' + res.status);
    }

    const data = await res.json();
    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || '...';

    // Add to history
    scState.conversationHistory.push({
      role: 'model',
      parts: [{ text: aiText }]
    });

    scState.lastAiText = aiText;

    // Detect mission complete
    const missionComplete = aiText.toUpperCase().includes('MISSION COMPLETE') ||
                            aiText.toUpperCase().includes('OUT.') && aiText.toUpperCase().includes('COMPLETE');

    // Update objectives progress heuristically
    updateObjectiveProgress(aiText, playerMessage);

    // Convert to morse and play
    await scPlayAiMorse(aiText, missionComplete);

  } catch(e) {
    scState.waiting = false;
    scSetStatus('ì˜¤ë¥˜', 'red');
    scAddMsg('system', null, 'âš  ì˜¤ë¥˜: ' + e.message);
    document.getElementById('scRcvStatus').textContent = 'ì—°ê²° ì˜¤ë¥˜';
    if (!scState.missionDone) {
      document.getElementById('scSendBtn').disabled = false;
    }
  }
}

// â”€â”€ Heuristic objective tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateObjectiveProgress(aiText, playerMsg) {
  const sc = scState.selectedScenario;
  const combined = ((aiText || '') + ' ' + (playerMsg || '')).toUpperCase();
  const total = sc.objectives.length;
  let done = 0;

  // Simple keyword heuristic per scenario
  const keywords = [
    ['TRENCH','ENEMY','POSITION','OBSERVATION','SPOTTED','REPORT','RECON',
     'COORDINATE','GRID','LOCATION','TARGET','TRANSMISSION','CONFIRM'],
    ['SUPPLY','AMMO','FOOD','RATION','STOCK','RESOURCE','FUEL','EQUIPMENT',
     'SURVIVOR','CASUALT','WOUND','RESCUE','SHIP','VESSEL'],
    ['READY','CONTINUE','SUSTAIN','COMBAT','FIGHT','PROCEED','EXTRACT',
     'FIRE','SHOOT','ADJUST','SALVO','RESULT','DAMAGE','EFFECT']
  ];

  // Count how many distinct keyword groups appear
  const seen = keywords.map(group =>
    group.some(kw => combined.includes(kw))
  );
  done = Math.min(seen.filter(Boolean).length, total);

  // Also check if AI acknowledged things
  if (aiText && (aiText.includes('RECEIVED') || aiText.includes('ROGER') ||
                  aiText.includes('COPY') || aiText.includes('UNDERSTOOD') ||
                  aiText.includes('CONFIRMED'))) {
    done = Math.min(done + 1, total);
  }

  // Update UI
  for(let i=0; i<total; i++) {
    if(i < done) completeObjective(i);
  }

  const pct = Math.round((done / total) * 90);
  if (pct > scState.missionProgress) setProgress(pct);
}

// â”€â”€ Text â†’ Morse string (with word spaces) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function textToMorseStr(text) {
  return text.toUpperCase().split('').map(ch => {
    if (ch === ' ') return '   ';   // word gap
    if (MORSE[ch])  return MORSE[ch] + ' ';
    return '';
  }).join('').trim();
}

// â”€â”€ Play AI morse with visual + add to log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function scPlayAiMorse(text, isFinal) {
  // Build morse
  const morseStr = textToMorseStr(text);
  scState.lastAiMorse = morseStr;

  document.getElementById('scRcvStatus').textContent = 'ìˆ˜ì‹  ì¤‘...';
  scSetStatus('ìˆ˜ì‹  ì¤‘', 'amber');

  // Add to log (incoming)
  scAddMsg('incoming', morseStr.replace(/\s+/g, ' '), text);

  // Play with visual
  const waveEl = document.getElementById('scSignalWave');
  const totalMs = await playMorseWithVisualAsync(morseStr, waveEl, 0.9);

  // After playback
  await delay(300);
  document.getElementById('scRcvStatus').textContent = 'ìˆ˜ì‹  ì™„ë£Œ â€” ì‘ì‹ í•˜ì„¸ìš”';
  scState.waiting = false;
  scSetStatus('êµì‹  ê°€ëŠ¥', 'green');

  if (isFinal) {
    // Mission complete
    setProgress(100);
    scState.missionProgress = 100;
    scState.missionDone = true;
    for(let i=0; i<scState.selectedScenario.objectives.length; i++) completeObjective(i);
    setTimeout(() => showMissionComplete(), 1500);
  } else {
    // Enable transmit
    document.getElementById('scSendBtn').disabled = false;
    document.getElementById('scSendBtn').focus();
  }
}

// Async version of playMorseWithVisual
function playMorseWithVisualAsync(morseStr, container, speed) {
  return new Promise(resolve => {
    container.innerHTML = '';

    const MAX_SLOTS = 14;  // ê°€ë¡œì— í‘œì‹œí•  ìµœëŒ€ ìŠ¬ë¡¯ ìˆ˜
    const dot  = 90 / speed;
    const dash = dot * 3;
    const gap  = dot;

    // ìŠ¬ë¡¯ ë¯¸ë¦¬ ìƒì„±
    for (let i = 0; i < MAX_SLOTS; i++) {
      const el = document.createElement('div');
      el.className = 'sw-dot';  // ê¸°ë³¸ê°’, ë‚˜ì¤‘ì— ë³€ê²½
      el.style.opacity = '0';
      container.appendChild(el);
    }

    // ì‹¬ë³¼ ì‹œí€€ìŠ¤ ìˆ˜ì§‘
    const segs = [];
    for (let ch of morseStr) {
      if (ch === '.' || ch === '-') segs.push(ch);
    }

    let t = 0;
    let si = 0;  // ì „ì²´ ì‹¬ë³¼ ì¹´ìš´í„°
    for (let ch of morseStr) {
      if (ch === '.' || ch === '-') {
        const symIdx = si;
        const dur = ch === '.' ? dot : dash;
        setTimeout(() => {
          const slotIdx = symIdx % MAX_SLOTS;  // ë¡¤ë§: ë„˜ìœ¼ë©´ ì²˜ìŒë¶€í„°
          const el = container.children[slotIdx];
          if (el) {
            // ëª¨ë“  ìŠ¬ë¡¯ ì´ˆê¸°í™” í›„ í˜„ì¬ ìŠ¬ë¡¯ë§Œ ì¼œê¸°
            // (í˜„ì¬ ìŠ¬ë¡¯ë§Œ ë°”ê¿”ì„œ ê¹œë°•ì„ íš¨ê³¼)
            el.className = ch === '.' ? 'sw-dot' : 'sw-dash';
            el.style.opacity = '1';
            el.classList.add('on');
            if (ch === '.') beep(dot / 1000, 700);
            else            beep(dash / 1000, 700);
            setTimeout(() => {
              el.classList.remove('on');
              el.style.opacity = '0.15';  // í”ì  í¬ë¯¸í•˜ê²Œ ë‚¨ê¹€
            }, dur);
          }
        }, t);
        t += dur + gap;
        si++;
      } else if (ch === ' ') {
        t += gap * 2;
      }
    }
    const total = t + 400;
    setTimeout(() => resolve(total), total);
  });
}

function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

// â”€â”€ Replay last AI signal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scReplayLast() {
  if (!scState.lastAiMorse) return;
  const waveEl = document.getElementById('scSignalWave');
  playMorseWithVisualAsync(scState.lastAiMorse, waveEl, 0.9);
}

// â”€â”€ Transmit: key press handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scKeyDown() {
  if (scState.waiting || scState.missionDone) return;
  if (scState.keyDown) return;
  scState.keyDown = true;
  scState.keyDownTime = Date.now();
  document.getElementById('scKeyBtn').classList.add('active');

  // Cancel word timer
  if (scState.wordTimerHandle) {
    clearTimeout(scState.wordTimerHandle);
    scState.wordTimerHandle = null;
  }
  document.getElementById('scWordTimer').textContent = '';
  keyToneStart();
}

function scKeyUp() {
  if (!scState.keyDown) return;
  scState.keyDown = false;
  keyToneStop();
  document.getElementById('scKeyBtn').classList.remove('active');

  const dur = Date.now() - scState.keyDownTime;
  const sym = dur < scState.dotThreshold ? '.' : '-';
  scState.currentMorse += sym;
  document.getElementById('scTxMorse').textContent = scState.currentMorse || 'â€”';

  // Attempt decode of current morse sequence
  const decoded = MORSE_REV[scState.currentMorse];
  if (decoded) {
    document.getElementById('scTxMorse').style.color = 'var(--green)';
  } else {
    document.getElementById('scTxMorse').style.color = 'rgba(57,255,90,0.5)';
  }

  // Start letter-confirm timer
  scStartWordTimer();

  // Enable send if we have content
  const totalWords = scState.completedWords;
  const totalChars = scState.completedChars;
  if (totalWords.length > 0 || totalChars.length > 0 || scState.currentMorse) {
    document.getElementById('scSendBtn').disabled = false;
  }
}

function scStartWordTimer() {
  if (scState.wordTimerHandle) clearTimeout(scState.wordTimerHandle);

  let countdown = Math.ceil(scState.wordTimerDelay / 100);
  const el = document.getElementById('scWordTimer');

  const tick = setInterval(() => {
    countdown--;
    if (countdown <= 0) {
      clearInterval(tick);
      el.textContent = '';
    } else {
      el.textContent = 'í™•ì •ê¹Œì§€ ' + (countdown * 0.1).toFixed(1) + 's';
    }
  }, 100);

  scState.wordTimerHandle = setTimeout(() => {
    clearInterval(tick);
    el.textContent = '';
    scConfirmLetter();
  }, scState.wordTimerDelay);
}

function scConfirmLetter() {
  if (!scState.currentMorse) return;
  const decoded = MORSE_REV[scState.currentMorse] || '?';
  scState.completedChars.push({ morse: scState.currentMorse, char: decoded });
  scState.currentMorse = '';

  document.getElementById('scTxMorse').textContent = 'â€”';
  document.getElementById('scTxMorse').style.color = 'var(--green)';
  renderWordBuffer();
  document.getElementById('scSendBtn').disabled = false;
}

function renderWordBuffer() {
  const buf = document.getElementById('scWordBuffer');
  // Build: completed words + current word chars
  const wordParts = scState.completedWords.map(w =>
    `<span class="wb-char">${w}</span><span style="color:var(--text-dim);font-family:'Share Tech Mono';padding:0 4px;">Â·</span>`
  ).join('');
  const charParts = scState.completedChars.map(c =>
    `<span class="wb-char">${c.char}</span>`
  ).join('');
  buf.innerHTML = wordParts + charParts;

  // Full sentence preview
  const sentence = buildSentence();
  document.getElementById('scTxSentence').textContent = sentence ? 'â†’ ' + sentence : '';
}

function buildSentence() {
  const words = [...scState.completedWords];
  const currentWord = scState.completedChars.map(c => c.char).join('');
  if (currentWord) words.push(currentWord);
  return words.join(' ');
}

// â”€â”€ Word boundary: double-tap or Enter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Space to confirm word boundary handled by long pause
// We also confirm current word on Enter before sending
function scConfirmWord() {
  // Confirm any pending letter
  if (scState.currentMorse) {
    const decoded = MORSE_REV[scState.currentMorse] || '?';
    scState.completedChars.push({ morse: scState.currentMorse, char: decoded });
    scState.currentMorse = '';
  }
  // Move chars to word
  if (scState.completedChars.length > 0) {
    const word = scState.completedChars.map(c => c.char).join('');
    scState.completedWords.push(word);
    scState.completedChars = [];
    renderWordBuffer();
  }
}

// â”€â”€ Send message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function scSendMessage() {
  if (scState.waiting || scState.missionDone) return;

  // Cancel timers
  if (scState.wordTimerHandle) {
    clearTimeout(scState.wordTimerHandle);
    scState.wordTimerHandle = null;
  }

  scConfirmWord();

  const sentence = buildSentence();
  if (!sentence || sentence.replace(/[?\s]/g,'').length === 0) return;

  // Build morse representation of what was sent
  const sentMorse = sentence.split('').map(ch => {
    if (ch === ' ') return '   ';
    if (MORSE[ch])  return MORSE[ch] + ' ';
    return '';
  }).join('').trim();

  // Add to log
  scAddMsg('outgoing', sentMorse, sentence);

  // Reset TX UI
  scState.completedWords = [];
  scState.completedChars = [];
  scState.currentMorse   = '';
  clearTxUI();
  document.getElementById('scSendBtn').disabled = true;

  // Get AI response
  await scGetAiResponse(sentence);
}

function scClearTx() {
  if (scState.wordTimerHandle) {
    clearTimeout(scState.wordTimerHandle);
    scState.wordTimerHandle = null;
  }
  scState.currentMorse   = '';
  scState.completedChars = [];
  scState.completedWords = [];
  clearTxUI();
  document.getElementById('scSendBtn').disabled = true;
}

function clearTxUI() {
  document.getElementById('scTxMorse').textContent  = 'â€”';
  document.getElementById('scTxMorse').style.color  = 'var(--green)';
  document.getElementById('scWordBuffer').innerHTML = '';
  document.getElementById('scTxSentence').textContent = '';
  document.getElementById('scWordTimer').textContent  = '';
}

// â”€â”€ Abort â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scAbortMission() {
  if (!confirm('ì‘ì „ì„ ì¤‘ë‹¨í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
  scState.missionDone = true;
  showScStep('select');
}

// â”€â”€ Mission complete UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showMissionComplete() {
  const sc = scState.selectedScenario;
  const totalMsgs = scState.conversationHistory.filter(m => m.role === 'user').length;

  let grade, gradeClass;
  if (totalMsgs <= 4)      { grade = 'S'; gradeClass = 'grade-S'; }
  else if (totalMsgs <= 7) { grade = 'A'; gradeClass = 'grade-A'; }
  else if (totalMsgs <= 10){ grade = 'B'; gradeClass = 'grade-B'; }
  else                      { grade = 'C'; gradeClass = 'grade-C'; }

  document.getElementById('missionOverlayTitle').textContent = 'ì„ë¬´ ì™„ë£Œ â€” ' + sc.title;
  document.getElementById('missionGrade').innerHTML =
    `<span class="${gradeClass}">${grade}</span>`;
  document.getElementById('missionOverlaySub').innerHTML =
    `êµì‹  íšŸìˆ˜: ${totalMsgs}íšŒ &nbsp;|&nbsp; ë“±ê¸‰: ${grade}<br>` +
    (grade === 'S' ? 'ì™„ë²½í•œ êµì‹ . ìµœì†Œí•œì˜ ì†¡ì‹ ìœ¼ë¡œ ì„ë¬´ ì™„ìˆ˜!' :
     grade === 'A' ? 'ìš°ìˆ˜í•œ êµì‹ . ê°„ê²°í•˜ê³  íš¨ê³¼ì ì¸ ë³´ê³ ì˜€ìŠµë‹ˆë‹¤.' :
     grade === 'B' ? 'ì–‘í˜¸í•œ êµì‹ . ë” ê°„ê²°í•˜ê²Œ ë³´ê³ í•˜ëŠ” ì—°ìŠµì„ í•˜ì„¸ìš”.' :
     'ì„ë¬´ëŠ” ì™„ìˆ˜í–ˆìœ¼ë‚˜ êµì‹ ì´ ë‹¤ì†Œ ê¸¸ì—ˆìŠµë‹ˆë‹¤.');

  document.getElementById('missionOverlay').classList.add('show');
}

function closeMissionOverlay() {
  document.getElementById('missionOverlay').classList.remove('show');
  showScStep('select');
}

// â”€â”€ Keyboard handler integration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// (merged into existing keydown/keyup listeners below)

// showScreen hook handled in main showScreen function

</script>

<!-- Mission Complete Overlay -->
<div class="mission-overlay" id="missionOverlay">
  <div class="mission-box">
    <div class="mission-title" id="missionOverlayTitle">ì„ë¬´ ì™„ë£Œ</div>
    <div class="mission-grade" id="missionGrade">A</div>
    <div style="font-family:'Share Tech Mono';font-size:0.8rem;color:var(--text-dim);letter-spacing:0.1em;line-height:1.8;margin-bottom:20px;" id="missionOverlaySub"></div>
    <div class="btn-row" style="justify-content:center;gap:12px;">
      <button class="btn btn-primary" onclick="closeMissionOverlay()">ê·€í™˜</button>
      <button class="btn btn-amber" onclick="scBeginMissionAgain()">ì¬ì‹œë„</button>
    </div>
  </div>
</div>

</body>
</html>
